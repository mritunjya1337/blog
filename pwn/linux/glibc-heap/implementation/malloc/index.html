
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="CTF Wiki EN">
      
      
        <meta name="author" content="mahaloz">
      
      
        <link rel="canonical" href="https://ctf-wiki.mahaloz.re/pwn/linux/glibc-heap/implementation/malloc/">
      
      
        <link rel="prev" href="../heap-init/">
      
      
        <link rel="next" href="../free/">
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Allocate Heap Memory - CTF Wiki EN</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../_static/css/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="pink" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#apply-for-a-memory-block" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="CTF Wiki EN" class="md-header__button md-logo" aria-label="CTF Wiki EN" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CTF Wiki EN
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Allocate Heap Memory
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/mahaloz/ctf-wiki-en" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    mahaloz/ctf-wiki-en
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../.." class="md-tabs__link">
          
  
  
  Introduction

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../misc/introduction/" class="md-tabs__link">
          
  
  
  Misc

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../crypto/introduction/" class="md-tabs__link">
          
  
  
  Crypto

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../web/introduction/" class="md-tabs__link">
          
  
  
  Web

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../assembly/x86-x64/readme/" class="md-tabs__link">
          
  
  
  Assembly

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../executable/elf/elf-structure.md" class="md-tabs__link">
          
  
  
  Executable

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../reverse/introduction/" class="md-tabs__link">
          
  
  
  Reverse Engineering

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../../readme/" class="md-tabs__link">
          
  
  
  Pwn

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../android/basic_develop/basic_develop/" class="md-tabs__link">
          
  
  
  Android

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../ics/ctfs/" class="md-tabs__link">
          
  
  
  ICS

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="CTF Wiki EN" class="md-nav__button md-logo" aria-label="CTF Wiki EN" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17z"/></svg>

    </a>
    CTF Wiki EN
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mahaloz/ctf-wiki-en" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    mahaloz/ctf-wiki-en
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Introduction
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../introduction/history/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CTF History
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../introduction/mode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CTF Competition Types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../introduction/content/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CTF Competition Topics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../introduction/experience/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Attack and Defense Experience Summary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../introduction/resources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Learning Resources
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Misc
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Misc
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Miscellaneous Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/recon/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Information Gathering Method
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Encoding Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Encoding Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/encode/communication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Encoding Used in Communication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/encode/computer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Encoding Used in Computing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/encode/modern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Encoding Used in the Real World
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/prereq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Forensic and Steganography Prerequisite
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Image Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Image Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/picture/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Image Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/picture/png/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PNG
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/picture/jpg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JPG
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/picture/gif/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GIF
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/audio/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Audio Steganography
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Traffic Packet Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            Traffic Packet Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Traffic Packet Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/fix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PCAP File Repairing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_3" >
        
          
          <label class="md-nav__link" for="__nav_2_7_3" id="__nav_2_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Protocol Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_3">
            <span class="md-nav__icon md-icon"></span>
            Protocol Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/protocols/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview of Protocol Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/protocols/Wireshark/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Wireshark
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/protocols/HTTP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HTTP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/protocols/HTTPS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    HTTPS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/protocols/FTP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FTP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/protocols/DNS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DNS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/protocols/WIFI/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WIFI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/protocols/USB/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    USB
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/traffic/data/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Data Extraction
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Compressed Package Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            Compressed Package Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/archive/zip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ZIP Format
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/archive/rar/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RAR Format
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Disk and Memory Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            Disk and Memory Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../misc/disk-memory/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Crypto
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Crypto
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Cryptography
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Basic Mathematics
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Basic Mathematics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/basic/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Classical Cipher
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Classical Cipher
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/classical/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Classical Cryptography
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/classical/monoalphabetic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Single table Substitution Cipher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/classical/polyalphabetic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-table Substitution Cipher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/classical/others/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Other Types of Cipher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/classical/summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Summary
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Stream Cipher
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            Stream Cipher
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/streamcipher/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_2" >
        
          
          <label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pseudo Random Number Generator
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_2">
            <span class="md-nav__icon md-icon"></span>
            Pseudo Random Number Generator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/streamcipher/prng/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/streamcipher/prng/csprng/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cryptographic Security Pseudo-random Number Generator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/streamcipher/prng/problem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Challenge Examples
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_3" >
        
          
          <label class="md-nav__link" for="__nav_3_4_3" id="__nav_3_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Linear Congruence Generator
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_3">
            <span class="md-nav__icon md-icon"></span>
            Linear Congruence Generator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/streamcipher/lcg/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/streamcipher/lcg/challenge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Example
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4_4" id="__nav_3_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Feedback Shift Register
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_4">
            <span class="md-nav__icon md-icon"></span>
            Feedback Shift Register
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/streamcipher/fsr/intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/streamcipher/fsr/lfsr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Linear Feedback Shift Register
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/streamcipher/fsr/nfsr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nonlinear Feedback Shift Register
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_5" >
        
          
          <label class="md-nav__link" for="__nav_3_4_5" id="__nav_3_4_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Special Stream Cipher
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_5">
            <span class="md-nav__icon md-icon"></span>
            Special Stream Cipher
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/streamcipher/special/rc4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RC4
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Block Cipher
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            Block Cipher
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Block Cipher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/arx-operations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ARX
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/des/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DES
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/idea/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IDEA
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/aes.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AES
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/simon-speck/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Simon and Speck
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5_7" >
        
          
          <label class="md-nav__link" for="__nav_3_5_7" id="__nav_3_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Group Mode
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_7">
            <span class="md-nav__icon md-icon"></span>
            Group Mode
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/mode/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/mode/padding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Padding Methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/mode/ecb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ECB
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/mode/cbc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CBC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/mode/pcbc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PCBC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/mode/cfb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CFB
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/mode/ofb/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OFB
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/mode/ctr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CTR
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/blockcipher/mode/padding-oracle-attack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Padding Oracle Attack
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Asymmetric Cryptography
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            Asymmetric Cryptography
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Asymmetric Cryptography
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6_2" >
        
          
          <label class="md-nav__link" for="__nav_3_6_2" id="__nav_3_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    RSA
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6_2">
            <span class="md-nav__icon md-icon"></span>
            RSA
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/rsa/rsa_theory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RSA Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/rsa/rsa_module_attack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Modulo-related Attacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/rsa/rsa_e_attack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Public Key Index Related Attacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/rsa/rsa_d_attack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Private Key d Related Attacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/rsa/rsa_coppersmith_attack.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Coppersmith Related Attacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/rsa/rsa_chosen_plain_cipher/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chosen Plain Cipher Attack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/rsa/rsa_side_channel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Side Channel Attack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/rsa/rsa_pkcs_attack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bleichenbacher Attack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/rsa/rsa_complex/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Challenge Examples
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/knapsack/knapsack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knapsack Cipher
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6_4" >
        
          
          <label class="md-nav__link" for="__nav_3_6_4" id="__nav_3_6_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Discrete Log Correlation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6_4">
            <span class="md-nav__icon md-icon"></span>
            Discrete Log Correlation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/discrete-log/discrete-log/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Discrete Logarithm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/discrete-log/elgamal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Elgamal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/discrete-log/ecc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ECC
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6_5" >
        
          
          <label class="md-nav__link" for="__nav_3_6_5" id="__nav_3_6_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Lattice-based Cryptography
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6_5">
            <span class="md-nav__icon md-icon"></span>
            Lattice-based Cryptography
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/lattice/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lattice Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/lattice/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Lattices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/lattice/lattice-reduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lattice-based Algorithm
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/asymmetric/lattice/cvp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CVP
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Hash Function
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            Hash Function
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/hash/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to the Hash Function
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/hash/md5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MD5
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/hash/sha1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SHA1
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/hash/fnv/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FNV
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/hash/attack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hash Attack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/hash/complex/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Challenge Examples
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Digital Signature
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            Digital Signature
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/signature/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Digital Signatures
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/signature/rsa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RSA Digital Signature
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/signature/elgamal.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ElGamal Digital Signature
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/signature/dsa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DSA Digital Signature
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_9" >
        
          
          <label class="md-nav__link" for="__nav_3_9" id="__nav_3_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Summary of Attack Techniques
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            Summary of Attack Techniques
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/attack-summary/attack-mode/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/attack-summary/meet-in-the-middle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Man in the Middle Attack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/attack-summary/bit-attack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Bit attack
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../crypto/certificate/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Certificate Format
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Web
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Web
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../web/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Web Applications
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../web/sqli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SQL Injection
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../web/xss.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    XSS Cross-Site Scripting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../web/csrf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CSRF Cross-Site Request Forgery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../web/ssrf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SSRF Server Request Forgery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../web/php/php/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PHP Code Auditing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Assembly
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Assembly
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../assembly/x86-x64/readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    x86_x64
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../assembly/mips/readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mips
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../assembly/arm/readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    arm
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Executable
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Executable
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_1" >
        
          
          <label class="md-nav__link" for="__nav_6_1" id="__nav_6_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ELF file
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_1">
            <span class="md-nav__icon md-icon"></span>
            ELF file
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../executable/elf/elf-structure.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ELF File Basic Structure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../executable/elf/program-loading/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Program Loading
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../executable/elf/program-linking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Program Link
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../executable/elf/running-overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Program Execution Flow
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    PE file
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            PE file
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../executable/pe/pe-excutable.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PE File Basic Structure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../executable/pe/pe-import-table.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PE Import Table
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../executable/pe/pe-export-table.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PE Export Table
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../executable/pe/pe-relocation-table.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PE Relocation Table
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reverse Engineering
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Reverse Engineering
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" >
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Reverse Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            Reverse Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Software Reverse Engineering Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/Identify-Encode-Encryption/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common Encryption Algorithms and Code Recognition
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/maze/maze/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Labyrinth Problem
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/vm/vm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Virtual Machine Command Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/unicorn/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unicorn Engine Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" >
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Linux Reverse
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            Linux Reverse
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2_1" >
        
          
          <label class="md-nav__link" for="__nav_7_2_1" id="__nav_7_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Linux Reverse Technology
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_2_1">
            <span class="md-nav__icon md-icon"></span>
            Linux Reverse Technology
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/linux/ld_preload/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LD_PRELOAD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/linux/false-disasm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Incorrect Disassembly Fix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/linux/detect-bp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Detecting Breakpoints Bypassing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/linux/detect-dbg/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Detecting Debugging Bypassing
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Windows Reverse
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Windows Reverse
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3_1" >
        
          
          <label class="md-nav__link" for="__nav_7_3_1" id="__nav_7_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Shelling Technique
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3_1">
            <span class="md-nav__icon md-icon"></span>
            Shelling Technique
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/unpack/packer-introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to the Protective case
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/unpack/trace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Single Step Tracking Method
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/unpack/esp/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ESP Law
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/unpack/direct-oep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    One Step to the OEP Method
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/unpack/memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory Mirroring Method
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/unpack/last-exception/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Last Exception Method
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/unpack/sfx/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SFX Method
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/unpack/fix-iat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DUMP and IAT Reconstruction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/unpack/manually-fix-iat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Manually Find the IAT and Rebuild It Using ImportREC
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/unpack/unpack-dll/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DLL File Unpacking
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3_2" >
        
          
          <label class="md-nav__link" for="__nav_7_3_2" id="__nav_7_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Anti-debugging Technique
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_7_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3_2">
            <span class="md-nav__icon md-icon"></span>
            Anti-debugging Technique
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/anti-debug/ntglobalflag/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NtGlobalFlag
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/anti-debug/heap-flags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Heap Flags
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/anti-debug/the-heap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    The Heap
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/anti-debug/int-3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Interrupt 3
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/anti-debug/isdebuggerpresent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    IsDebuggerPresent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/anti-debug/checkremotedebuggerpresent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CheckRemoteDebuggerPresent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/anti-debug/ntqueryinformationprocess/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    NtQueryInformationProcess
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/anti-debug/zwsetinformationthread/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ZwSetInformationThread
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/anti-debug/junk-code/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Flower command
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../reverse/windows/anti-debug/example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Anti-debug Technical Example
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Pwn
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Pwn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" >
        
          
          <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pwn Overview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_1">
            <span class="md-nav__icon md-icon"></span>
            Pwn Overview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Readme
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" checked>
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Linux Pwn
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            Linux Pwn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_1" >
        
          
          <label class="md-nav__link" for="__nav_8_2_1" id="__nav_8_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Security Protection Mechanism
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_1">
            <span class="md-nav__icon md-icon"></span>
            Security Protection Mechanism
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../mitigation/canary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Canary
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_2" >
        
          
          <label class="md-nav__link" for="__nav_8_2_2" id="__nav_8_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Stack Overflow
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_2">
            <span class="md-nav__icon md-icon"></span>
            Stack Overflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../stackoverflow/stack-intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stack Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../stackoverflow/stackoverflow-basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stack Overflow Principle
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../stackoverflow/basic-rop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic ROP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../stackoverflow/medium-rop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intermediate ROP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../stackoverflow/advanced-rop.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Advanced ROP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../stackoverflow/fancy-rop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ROP Tricks
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_3" >
        
          
          <label class="md-nav__link" for="__nav_8_2_3" id="__nav_8_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Format String Vulnerability
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_3">
            <span class="md-nav__icon md-icon"></span>
            Format String Vulnerability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fmtstr/fmtstr_intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Format String Vulnerability Principle
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fmtstr/fmtstr_exploit.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Format String Exploit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fmtstr/fmtstr_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Format String Vulnerability Example
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fmtstr/fmtstr_detect/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Format String Vulnerability Detection
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_4" checked>
        
          
          <label class="md-nav__link" for="__nav_8_2_4" id="__nav_8_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Glibc Heap Related
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8_2_4">
            <span class="md-nav__icon md-icon"></span>
            Glibc Heap Related
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to Heap
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../heap_overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Heap Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../heap_structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Heap Related Data Structure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_4_4" checked>
        
          
          <label class="md-nav__link" for="__nav_8_2_4_4" id="__nav_8_2_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    In-depth Explanation of Ptmalloc2
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_8_2_4_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8_2_4_4">
            <span class="md-nav__icon md-icon"></span>
            In-depth Explanation of Ptmalloc2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basic Functions in the heap implementation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../heap-init/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Heap Initialization
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Allocate Heap Memory
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Allocate Heap Memory
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#__libc_malloc" class="md-nav__link">
    <span class="md-ellipsis">
      __libc_malloc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_int_malloc" class="md-nav__link">
    <span class="md-ellipsis">
      _int_malloc
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_int_malloc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#arena" class="md-nav__link">
    <span class="md-ellipsis">
      arena
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fast-bin" class="md-nav__link">
    <span class="md-ellipsis">
      fast bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#small-bin" class="md-nav__link">
    <span class="md-ellipsis">
      small bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#large-bin" class="md-nav__link">
    <span class="md-ellipsis">
      large bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#big-loop-traversing-unsorted-bin" class="md-nav__link">
    <span class="md-ellipsis">
      Big loop - traversing unsorted bin
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Big loop - traversing unsorted bin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unsorted-bin-traversing" class="md-nav__link">
    <span class="md-ellipsis">
      unsorted bin Traversing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="unsorted bin Traversing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#small-request" class="md-nav__link">
    <span class="md-ellipsis">
      small request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initial-take-out" class="md-nav__link">
    <span class="md-ellipsis">
      Initial take out
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exact-fit" class="md-nav__link">
    <span class="md-ellipsis">
      exact fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#place-chunk-in-small-bin" class="md-nav__link">
    <span class="md-ellipsis">
      place chunk in small bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#place-chunk-in-large-bin" class="md-nav__link">
    <span class="md-ellipsis">
      place chunk in large bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-take-out" class="md-nav__link">
    <span class="md-ellipsis">
      Final take out
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#while-iterations" class="md-nav__link">
    <span class="md-ellipsis">
      while Iterations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#large-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      large chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#looking-for-a-larger-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      Looking for a larger chunk
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Looking for a larger chunk">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-a-suitable-map" class="md-nav__link">
    <span class="md-ellipsis">
      Find a suitable map
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-the-right-bin" class="md-nav__link">
    <span class="md-ellipsis">
      Find the right bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simple-check-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      Simple check chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#really-take-out-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      Really take out chunk
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-top-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      Using top chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heap-memory-is-not-enough" class="md-nav__link">
    <span class="md-ellipsis">
      Heap memory is not enough
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_libc_calloc" class="md-nav__link">
    <span class="md-ellipsis">
      _libc_calloc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sysmalloc" class="md-nav__link">
    <span class="md-ellipsis">
      sysmalloc
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sysmalloc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Basic definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consider-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      Consider mmap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mmap-failed-or-unallocated-heap" class="md-nav__link">
    <span class="md-ellipsis">
      mmap failed or unallocated heap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recording-old-heap-information" class="md-nav__link">
    <span class="md-ellipsis">
      Recording old heap information
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-old-heap-information-1" class="md-nav__link">
    <span class="md-ellipsis">
      Check old heap information 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-old-heap-information-2" class="md-nav__link">
    <span class="md-ellipsis">
      Check old heap information 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#non-main_arena" class="md-nav__link">
    <span class="md-ellipsis">
      Non main_arena
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#main_arena-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Main_arena Processing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Main_arena Processing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#calculating-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Calculating memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#whether-it-is-continuous" class="md-nav__link">
    <span class="md-ellipsis">
      Whether it is continuous
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#align-page-size" class="md-nav__link">
    <span class="md-ellipsis">
      Align page size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applying-for-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Applying for memory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Applying for memory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#may-succeed" class="md-nav__link">
    <span class="md-ellipsis">
      May succeed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#failed" class="md-nav__link">
    <span class="md-ellipsis">
      Failed
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-may-be-applied-successfully" class="md-nav__link">
    <span class="md-ellipsis">
      Memory may be applied successfully
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory may be applied successfully">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#situation-1" class="md-nav__link">
    <span class="md-ellipsis">
      Situation 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case-2-unexpected-memory-exhaustion" class="md-nav__link">
    <span class="md-ellipsis">
      Case 2 - Unexpected memory exhaustion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-other-unexpected-situations" class="md-nav__link">
    <span class="md-ellipsis">
      Handling other unexpected situations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Handling other unexpected situations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#processing-contiguous-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Processing contiguous memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-discontinuous-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Handling discontinuous memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      Adjustment
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-maximum-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Update maximum memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocating-memory-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      Allocating memory blocks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Allocating memory blocks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-the-size" class="md-nav__link">
    <span class="md-ellipsis">
      Get the size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#top" class="md-nav__link">
    <span class="md-ellipsis">
      切分 top
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capture-all-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Capture all errors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../free/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Free Heap Memory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tcache/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tcache
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../malloc_state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    malloc_state
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../misc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Other
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../heapoverflow_basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Heap Overflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../off_by_one/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Heap-based Off-By-One
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chunk_extend_overlapping/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chunk Extend/Overlapping
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unlink.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unlink
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../use_after_free/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Use After Free
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fastbin_attack.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fastbin Attack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unsorted_bin_attack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unsorted Bin Attack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../large_bin_attack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Large Bin Attack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tcache_attack.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tcache Attack
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../house_of_einherjar/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    House of Einherjar
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../house_of_force/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    House of Force
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../house_of_lore/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    House of Lore
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../house_of_orange/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    House of Orange
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../house_of_rabbit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    House of Rabbit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../house_of_roman/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    House of Roman
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_5" >
        
          
          <label class="md-nav__link" for="__nav_8_2_5" id="__nav_8_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    IO_FILE Related
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_5">
            <span class="md-nav__icon md-icon"></span>
            IO_FILE Related
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../io_file/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FILE Structure Description
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../io_file/fake-vtable-exploit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Forged Vtable to Hijack Control Flow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../io_file/fsop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FSOP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../io_file/exploit-in-libc2.24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Use of IO_FILE Under Glibc 2.24
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_6" >
        
          
          <label class="md-nav__link" for="__nav_8_2_6" id="__nav_8_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Race Condition
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_6">
            <span class="md-nav__icon md-icon"></span>
            Race Condition
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../race-condition/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Race Condition Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../race-condition/problem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Example
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_7" >
        
          
          <label class="md-nav__link" for="__nav_8_2_7" id="__nav_8_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Integer Overflow
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_7">
            <span class="md-nav__icon md-icon"></span>
            Integer Overflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../integeroverflow/intof/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction to The Principle of Integer Overflow
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_8" >
        
          
          <label class="md-nav__link" for="__nav_8_2_8" id="__nav_8_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Sandbox Escape
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_8">
            <span class="md-nav__icon md-icon"></span>
            Sandbox Escape
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../sandbox/python-sandbox-escape/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python Sandbox Escape
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_9" >
        
          
          <label class="md-nav__link" for="__nav_8_2_9" id="__nav_8_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Linux Kernel
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_9">
            <span class="md-nav__icon md-icon"></span>
            Linux Kernel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kernel/environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environment Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kernel/basic_knowledge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kernel/kernel_uaf/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kernel-UAF
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kernel/kernel_rop.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Kernel-ROP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kernel/ret2usr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ret2usr
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kernel/bypass_smep/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    bypass-smep
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../kernel/double-fetch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Double Fetch
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_10" >
        
          
          <label class="md-nav__link" for="__nav_8_2_10" id="__nav_8_2_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    arm-pwn
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_10">
            <span class="md-nav__icon md-icon"></span>
            arm-pwn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../arm/environment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Environment Setup
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../arm/arm_rop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    arm-rop
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2_11" >
        
          
          <label class="md-nav__link" for="__nav_8_2_11" id="__nav_8_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Summary
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2_11">
            <span class="md-nav__icon md-icon"></span>
            Summary
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../summary/get-address/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Address Leaking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../summary/hijack-control-flow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hijack Control Flow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../summary/get-shell/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Get Shell
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3" >
        
          
          <label class="md-nav__link" for="__nav_8_3" id="__nav_8_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Windows Pwn
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3">
            <span class="md-nav__icon md-icon"></span>
            Windows Pwn
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../windows/readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_3_2" >
        
          
          <label class="md-nav__link" for="__nav_8_3_2" id="__nav_8_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Stack Overflow
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_8_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_3_2">
            <span class="md-nav__icon md-icon"></span>
            Stack Overflow
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../windows/stackoverflow/stack-introduce/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stack Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../windows/stackoverflow/stackoverflow-basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stack Overflow Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../windows/stackoverflow/shellcode-in-stack/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    shellcode-in-stack
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Android
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Android
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_develop/basic_develop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Android Development Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2" >
        
          
          <label class="md-nav__link" for="__nav_9_2" id="__nav_9_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Android Application Operating Mechanism Brief
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_9_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2">
            <span class="md-nav__icon md-icon"></span>
            Android Application Operating Mechanism Brief
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_operating_mechanism/readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_2" >
        
          
          <label class="md-nav__link" for="__nav_9_2_2" id="__nav_9_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    The Operating Mechanism of the Java Layer in Android
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2_2">
            <span class="md-nav__icon md-icon"></span>
            The Operating Mechanism of the Java Layer in Android
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_operating_mechanism/java_layer/readme/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Andriod Native
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_operating_mechanism/java_layer/smali/smali.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Smali Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_2_3" >
        
          
          <label class="md-nav__link" for="__nav_9_2_2_3" id="__nav_9_2_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Dex and ODEX
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_2_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2_2_3">
            <span class="md-nav__icon md-icon"></span>
            Dex and ODEX
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_operating_mechanism/java_layer/dex/dex/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DEX
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_operating_mechanism/java_layer/dex/odex/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ODEX
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_3" >
        
          
          <label class="md-nav__link" for="__nav_9_2_3" id="__nav_9_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Android Native Layer Introduction
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2_3">
            <span class="md-nav__icon md-icon"></span>
            Android Native Layer Introduction
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_operating_mechanism/native_layer/so/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Android Shared Object
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_4" >
        
          
          <label class="md-nav__link" for="__nav_9_2_4" id="__nav_9_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Android Reverse Basic Introduction
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_9_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2_4">
            <span class="md-nav__icon md-icon"></span>
            Android Reverse Basic Introduction
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_reverse/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Brief Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_reverse/android_code_location/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Android Key Part Location
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_4_3" >
        
          
          <label class="md-nav__link" for="__nav_9_2_4_3" id="__nav_9_2_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Android Simple Static Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_2_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2_4_3">
            <span class="md-nav__icon md-icon"></span>
            Android Simple Static Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_reverse/static/java-example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Android Java Layer Static Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_reverse/static/so-example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Android Native Layer Static Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_reverse/static/complex-example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Android Static Analysis Hybrid Example
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9_2_4_4" >
        
          
          <label class="md-nav__link" for="__nav_9_2_4_4" id="__nav_9_2_4_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Android Simple Dynamic Analysis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_9_2_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9_2_4_4">
            <span class="md-nav__icon md-icon"></span>
            Android Simple Dynamic Analysis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_reverse/dynamic/dynamic_debug/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dynamic Debugging
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../android/basic_reverse/dynamic/ida_native_debug/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Android Dynamic Debugging SO
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    ICS
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            ICS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ics/ctfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ICS_CTF Contest
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ics/discover/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ICS_CTF Discovery
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ics/exploit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ICS_CTF Exploit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../ics/learn/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ICS_CTF Learning Resources
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#__libc_malloc" class="md-nav__link">
    <span class="md-ellipsis">
      __libc_malloc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_int_malloc" class="md-nav__link">
    <span class="md-ellipsis">
      _int_malloc
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_int_malloc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#arena" class="md-nav__link">
    <span class="md-ellipsis">
      arena
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fast-bin" class="md-nav__link">
    <span class="md-ellipsis">
      fast bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#small-bin" class="md-nav__link">
    <span class="md-ellipsis">
      small bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#large-bin" class="md-nav__link">
    <span class="md-ellipsis">
      large bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#big-loop-traversing-unsorted-bin" class="md-nav__link">
    <span class="md-ellipsis">
      Big loop - traversing unsorted bin
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Big loop - traversing unsorted bin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unsorted-bin-traversing" class="md-nav__link">
    <span class="md-ellipsis">
      unsorted bin Traversing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="unsorted bin Traversing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#small-request" class="md-nav__link">
    <span class="md-ellipsis">
      small request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initial-take-out" class="md-nav__link">
    <span class="md-ellipsis">
      Initial take out
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exact-fit" class="md-nav__link">
    <span class="md-ellipsis">
      exact fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#place-chunk-in-small-bin" class="md-nav__link">
    <span class="md-ellipsis">
      place chunk in small bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#place-chunk-in-large-bin" class="md-nav__link">
    <span class="md-ellipsis">
      place chunk in large bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-take-out" class="md-nav__link">
    <span class="md-ellipsis">
      Final take out
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#while-iterations" class="md-nav__link">
    <span class="md-ellipsis">
      while Iterations
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#large-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      large chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#looking-for-a-larger-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      Looking for a larger chunk
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Looking for a larger chunk">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#find-a-suitable-map" class="md-nav__link">
    <span class="md-ellipsis">
      Find a suitable map
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#find-the-right-bin" class="md-nav__link">
    <span class="md-ellipsis">
      Find the right bin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simple-check-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      Simple check chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#really-take-out-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      Really take out chunk
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-top-chunk" class="md-nav__link">
    <span class="md-ellipsis">
      Using top chunk
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#heap-memory-is-not-enough" class="md-nav__link">
    <span class="md-ellipsis">
      Heap memory is not enough
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_libc_calloc" class="md-nav__link">
    <span class="md-ellipsis">
      _libc_calloc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sysmalloc" class="md-nav__link">
    <span class="md-ellipsis">
      sysmalloc
    </span>
  </a>
  
    <nav class="md-nav" aria-label="sysmalloc">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-definition" class="md-nav__link">
    <span class="md-ellipsis">
      Basic definition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consider-mmap" class="md-nav__link">
    <span class="md-ellipsis">
      Consider mmap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mmap-failed-or-unallocated-heap" class="md-nav__link">
    <span class="md-ellipsis">
      mmap failed or unallocated heap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#recording-old-heap-information" class="md-nav__link">
    <span class="md-ellipsis">
      Recording old heap information
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-old-heap-information-1" class="md-nav__link">
    <span class="md-ellipsis">
      Check old heap information 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-old-heap-information-2" class="md-nav__link">
    <span class="md-ellipsis">
      Check old heap information 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#non-main_arena" class="md-nav__link">
    <span class="md-ellipsis">
      Non main_arena
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#main_arena-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Main_arena Processing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Main_arena Processing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#calculating-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Calculating memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#whether-it-is-continuous" class="md-nav__link">
    <span class="md-ellipsis">
      Whether it is continuous
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#align-page-size" class="md-nav__link">
    <span class="md-ellipsis">
      Align page size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applying-for-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Applying for memory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Applying for memory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#may-succeed" class="md-nav__link">
    <span class="md-ellipsis">
      May succeed
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#failed" class="md-nav__link">
    <span class="md-ellipsis">
      Failed
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-may-be-applied-successfully" class="md-nav__link">
    <span class="md-ellipsis">
      Memory may be applied successfully
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Memory may be applied successfully">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#situation-1" class="md-nav__link">
    <span class="md-ellipsis">
      Situation 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#case-2-unexpected-memory-exhaustion" class="md-nav__link">
    <span class="md-ellipsis">
      Case 2 - Unexpected memory exhaustion
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-other-unexpected-situations" class="md-nav__link">
    <span class="md-ellipsis">
      Handling other unexpected situations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Handling other unexpected situations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#processing-contiguous-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Processing contiguous memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-discontinuous-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Handling discontinuous memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adjustment" class="md-nav__link">
    <span class="md-ellipsis">
      Adjustment
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-maximum-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Update maximum memory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#allocating-memory-blocks" class="md-nav__link">
    <span class="md-ellipsis">
      Allocating memory blocks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Allocating memory blocks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get-the-size" class="md-nav__link">
    <span class="md-ellipsis">
      Get the size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#top" class="md-nav__link">
    <span class="md-ellipsis">
      切分 top
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#capture-all-errors" class="md-nav__link">
    <span class="md-ellipsis">
      Capture all errors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="apply-for-a-memory-block">Apply for a memory block<a class="headerlink" href="#apply-for-a-memory-block" title="Permanent link">&para;</a></h1>
<h2 id="__libc_malloc">__libc_malloc<a class="headerlink" href="#__libc_malloc" title="Permanent link">&para;</a></h2>
<p>In general, we will use the malloc function to apply for a block of memory, but when we look closely at the source implementation of glibc, there is actually no malloc function. In fact, the function actually calls the __libc_malloc function. Why not just write a malloc function directly, because sometimes we may need different names. In addition, the __libc_malloc function is simply used to simply wrap the _int_malloc function. _int_malloc is the core of the application memory block. Let's take a closer look at the specific implementation.</p>
<p>This function first checks if there is a hook function (__malloc_hook) for the memory allocation function. This is mainly used for user-defined heap allocation functions, which is convenient for users to quickly modify and evaluate the allocation function. It should be noted here that the ** user-applied byte becomes an unsigned integer** once it enters the application memory function.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// wapper for int_malloc</span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">__libc_malloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">mstate</span><span class="w"> </span><span class="n">ar_ptr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Check if there is a memory allocation hook, if so, call the hook and return.</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_forced_read</span><span class="p">(</span><span class="n">__malloc_hook</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">hook</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">RETURN_ADDRESS</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</code></pre></div>
<p>Then I will look for an arena to try to allocate memory.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">arena_get</span><span class="p">(</span><span class="n">ar_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</code></pre></div>
<p>Then call the _int_malloc function to request the corresponding memory.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_int_malloc</span><span class="p">(</span><span class="n">ar_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
</code></pre></div>
<p>If the allocation fails, ptmalloc will try to find another available arena and allocate memory.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cm">/* Retry with another arena only if we were able to find a usable arena</span>
<span class="cm">       before.  */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">victim</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ar_ptr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LIBC_PROBE</span><span class="p">(</span><span class="n">memory_malloc_retry</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">        </span><span class="n">ar_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arena_get_retry</span><span class="p">(</span><span class="n">ar_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">        </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_int_malloc</span><span class="p">(</span><span class="n">ar_ptr</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>If you apply for arena, you have to unlock it before you quit.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ar_ptr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="n">__libc_lock_unlock</span><span class="p">(</span><span class="n">ar_ptr</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
</code></pre></div>
<p>Determine if the current status meets the following conditions</p>
<ul>
<li>Either didn't apply to memory</li>
<li>either mmap memory</li>
<li><strong>Either the requested memory must be in its assigned arena</strong></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">victim</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">chunk_is_mmapped</span><span class="p">(</span><span class="n">mem2chunk</span><span class="p">(</span><span class="n">victim</span><span class="p">))</span><span class="w"> </span><span class="o">||</span>
<span class="w">           </span><span class="n">ar_ptr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">arena_for_chunk</span><span class="p">(</span><span class="n">mem2chunk</span><span class="p">(</span><span class="n">victim</span><span class="p">)));</span>
</code></pre></div>
<p>Finally return to memory.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="_int_malloc">_int_malloc<a class="headerlink" href="#_int_malloc" title="Permanent link">&para;</a></h2>
<p>_int_malloc is the core function of memory allocation, and its core ideas are as follows</p>
<ol>
<li>It implements different allocation methods in turn according to the <strong>memory block size</strong> and <strong>frequency of use</strong> of fastbin chunk, small chunk, large chunk of the user's application.</li>
<li>It checks from small to large whether there are corresponding free blocks in different bins to satisfy the memory requested by the user.</li>
<li>When all free chunks are not met, it considers the top chunk.</li>
<li>The heap allocator will only request the memory block when the top chunk is not satisfied.</li>
</ol>
<p>After entering the function, the function immediately defines a series of variables that you need, and converts the memory size requested by the user to the internal chunk size.</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">_int_malloc</span><span class="p">(</span><span class="n">mstate</span><span class="w"> </span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">INTERNAL_SIZE_T</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span><span class="w">  </span><span class="cm">/* normalized request size */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="n">idx</span><span class="p">;</span><span class="w"> </span><span class="cm">/* associated bin index */</span>
<span class="w">    </span><span class="n">mbinptr</span><span class="w">         </span><span class="n">bin</span><span class="p">;</span><span class="w"> </span><span class="cm">/* associated bin */</span>

<span class="w">    </span><span class="n">mchunkptr</span><span class="w">       </span><span class="n">victim</span><span class="p">;</span><span class="w">       </span><span class="cm">/* inspected/selected chunk */</span>
<span class="w">    </span><span class="n">INTERNAL_SIZE_T</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w">         </span><span class="cm">/* its size */</span>
<span class="w">    </span><span class="kt">int</span><span class="w">             </span><span class="n">victim_index</span><span class="p">;</span><span class="w"> </span><span class="cm">/* its bin index */</span>

<span class="w">    </span><span class="n">mchunkptr</span><span class="w">     </span><span class="n">remainder</span><span class="p">;</span><span class="w">      </span><span class="cm">/* remainder from a split */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">remainder_size</span><span class="p">;</span><span class="w"> </span><span class="cm">/* its size */</span>

<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">block</span><span class="p">;</span><span class="w"> </span><span class="cm">/* bit map traverser */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">bit</span><span class="p">;</span><span class="w">   </span><span class="cm">/* bit map traverser */</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">map</span><span class="p">;</span><span class="w">   </span><span class="cm">/* current word of binmap */</span>

<span class="w">    </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span><span class="w"> </span><span class="cm">/* misc temp for linking */</span>
<span class="w">    </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span><span class="w"> </span><span class="cm">/* misc temp for linking */</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">errstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">       Convert request size to internal form by adding SIZE_SZ bytes</span>
<span class="cm">       overhead plus possibly more to obtain necessary alignment and/or</span>
<span class="cm">       to obtain a size of at least MINSIZE, the smallest allocatable</span>
<span class="cm">       size. Also, checked_request2size traps (returning 0) request sizes</span>
<span class="cm">       that are so large that they wrap around zero when padded and</span>
<span class="cm">       aligned.</span>
<span class="cm">     */</span>

<span class="w">    </span><span class="n">checked_request2size</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
</code></pre></div>
<h3 id="arena">arena<a class="headerlink" href="#arena" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cm">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from</span>
<span class="cm">       mmap.  */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysmalloc</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="w"> </span><span class="n">av</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h3 id="fast-bin">fast bin<a class="headerlink" href="#fast-bin" title="Permanent link">&para;</a></h3>
<p>If the size of the requested chunk is in the fastbin range, ** note that the comparison here is an unsigned integer<strong>. ** In addition, chunk</strong> is taken from the head node of fastbin.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cm">/*</span>
<span class="cm">       If the size qualifies as a fastbin, first check corresponding bin.</span>
<span class="cm">       This code is safe to execute even if av is not yet initialized, so we</span>
<span class="cm">       can try it without checking, which saves some time on this fast path.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">get_max_fast</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Get the corresponding subscript of fastbin</span>
<span class="w">        </span><span class="n">idx</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="n">fastbin_index</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Get the corresponding pointer to the fastbin</span>
<span class="w">        </span><span class="n">mfastbinptr</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">fastbin</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
<span class="w">        </span><span class="n">mchunkptr</span><span class="w">    </span><span class="n">pp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">fb</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Use fd to traverse the corresponding bin whether there are free chunks,</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pp</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">pp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catomic_compare_and_exchange_val_acq</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span>
<span class="w">                                                            </span><span class="n">victim</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">victim</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// There are chunks that can be used</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Check if the chunk size retrieved is consistent with the corresponding fastbin index.</span>
<span class="w">            </span><span class="c1">// Calculate its size using chunksize based on the obtained victim.</span>
<span class="w">            </span><span class="c1">// Calculate the index of the chunk using fastbin_index.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">fastbin_index</span><span class="p">(</span><span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">errstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;malloc(): memory corruption (fast)&quot;</span><span class="p">;</span>

<span class="w">            </span><span class="nl">errout</span><span class="p">:</span>
<span class="w">                </span><span class="n">malloc_printerr</span><span class="p">(</span><span class="n">check_action</span><span class="p">,</span><span class="w"> </span><span class="n">errstr</span><span class="p">,</span><span class="w"> </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">),</span><span class="w"> </span><span class="n">av</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="c1">// Careful inspection. . Useful only when DEBUG</span>
<span class="w">            </span><span class="n">check_remalloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Convert the obtained chunk to mem mode</span>
<span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff</span>
<span class="w">            </span><span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h3 id="small-bin">small bin<a class="headerlink" href="#small-bin" title="Permanent link">&para;</a></h3>
<p>If the range of the obtained memory block is in the range of the small bin, then the following process is performed.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cm">/*</span>
<span class="cm">       If a small request, check regular bin.  Since these &quot;smallbins&quot;</span>
<span class="cm">       hold one size each, no searching within bins is necessary.</span>
<span class="cm">       (For a large request, we need to wait until unsorted chunks are</span>
<span class="cm">       processed to find best fit. But for small ones, fits are exact</span>
<span class="cm">       anyway, so we can check now, which is faster.)</span>
<span class="cm">     */</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">nb</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Get the index of the small bin</span>
<span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smallbin_index</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Get the corresponding chunk pointer in the small bin</span>
<span class="w">        </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// first execute victim = last(bin) to get the last chunk of the small bin</span>
<span class="w">        </span><span class="c1">// If victim = bin , then the bin is empty.</span>
<span class="w">        </span><span class="c1">// If they are not equal, then there will be two cases</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="p">(</span><span class="n">bin</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// In the first case, the small bin has not yet been initialized.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="cm">/* initialization check */</span>
<span class="w">                </span><span class="c1">// Perform initialization to merge chunks in fast bins</span>
<span class="w">                </span><span class="n">malloc_consolidate</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// In the second case, there is a free chunk in the small bin</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Get the second-to-last chunk in the small bin.</span>
<span class="w">                </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
<span class="w">                </span><span class="c1">// Check if bck-&gt;fd is victim, prevent forgery</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="p">(</span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">victim</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">errstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;malloc(): smallbin double linked list corrupted&quot;</span><span class="p">;</span>
<span class="w">                    </span><span class="k">goto</span><span class="w"> </span><span class="n">errout</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">// Set the corresponding inuse bit of victim</span>
<span class="w">                </span><span class="n">set_inuse_bit_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Modify the small bin list, take the last chunk of the small bin</span>
<span class="w">                </span><span class="n">bin</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
<span class="w">                </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin</span><span class="p">;</span>
<span class="w">                </span><span class="c1">// If it is not main_arena, set the corresponding flag</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span><span class="w"> </span><span class="n">set_non_main_arena</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Detailed inspection, non-debug status has no effect</span>
<span class="w">                </span><span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Convert the requested chunk to the corresponding mem state</span>
<span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff</span>
<span class="w">                </span><span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h3 id="large-bin">large bin<a class="headerlink" href="#large-bin" title="Permanent link">&para;</a></h3>
<p>When the chunks in the fast bin and small bin cannot satisfy the user request chunk hour, it will consider whether it is a large bin. However, in the large bin, there is no direct scan of the chunk in the corresponding bin. Instead, the malloc_consolidate(see malloc_state related function) function is used to process the chunk in the fast bin, and the chunks that may be merged are merged and then placed. In the unsorted bin, if you can't merge, put it directly into the unsorted bin, and then process it in the big loop below. ** Why not just take the large chunk directly from the corresponding bin? This is the mechanism of ptmalloc, which merges fragment chunks in the heap before allocating large chunks to reduce fragmentation in the heap. **</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cm">/*</span>
<span class="cm">       If this is a large request, consolidate fastbins before continuing.</span>
<span class="cm">       While it might look excessive to kill all fastbins before</span>
<span class="cm">       even seeing if there is space available, this avoids</span>
<span class="cm">       fragmentation problems normally associated with fastbins.</span>
<span class="cm">       Also, in practice, programs tend to have runs of either small or</span>
<span class="cm">       large requests, but less often mixtures, so consolidation is not</span>
<span class="cm">       invoked all that often in most programs. And the programs that</span>
<span class="cm">       it is called frequently in otherwise tend to fragment.</span>
<span class="cm">     */</span>

<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Get the subscript of the large bin.</span>
<span class="w">        </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">largebin_index</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// If there is fastbin, it will handle fastbin</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">have_fastchunks</span><span class="p">(</span><span class="n">av</span><span class="p">))</span><span class="w"> </span><span class="n">malloc_consolidate</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h3 id="big-loop-traversing-unsorted-bin">Big loop - traversing unsorted bin<a class="headerlink" href="#big-loop-traversing-unsorted-bin" title="Permanent link">&para;</a></h3>
<p>**If the program is executed here, it means that there is no chunk in the bin (fast bin, small bin) that is exactly the same as the chunk size, which can directly satisfy the demand, but the large chunk is processed in this big loop.</p>
<p>In the next cycle, the main operations are as follows</p>
<ul>
<li>Take the chunks in the unsorted bin one by one in the FIFO mode</li>
<li>If it is a small request, consider whether it is just satisfied, if it is, return directly.</li>
<li>If not, put it in the corresponding bin.</li>
<li>Try to allocate the memory required by the user from the large bin</li>
</ul>
<p>This part is a big loop, this is to try to redistribute the small bin chunk, because we will first use the large bin, top chunk to try to satisfy the user's request, but if it is not satisfied, because we did not assign it successfully Small bin, we didn't merge the chunks in the fast bin, so we'll merge the fast bin chunks and use a big loop to try to allocate the small bin chunk again.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cm">/*</span>
<span class="cm">       Process recently freed or remaindered chunks, taking one only if</span>
<span class="cm">       it is exact fit, or, if this a small request, the chunk is remainder from</span>
<span class="cm">       the most recent non-exact fit.  Place other traversed chunks in</span>
<span class="cm">       bins.  Note that this step is the only place in any routine where</span>
<span class="cm">       chunks are placed in bins.</span>

<span class="cm">       The outer loop here is needed because we might not realize until</span>
<span class="cm">       near the end of malloc that we should have consolidated, so must</span>
<span class="cm">       do so and retry. This happens at most once, and only when we would</span>
<span class="cm">       otherwise need to expand memory to service a &quot;small&quot; request.</span>
<span class="cm">     */</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">iters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>
<h4 id="unsorted-bin-traversing">unsorted bin Traversing<a class="headerlink" href="#unsorted-bin-traversing" title="Permanent link">&para;</a></h4>
<p>Consider the unsorted bin first, then consider the last remainder, but there are exceptions to the request for the small bin chunk.</p>
<p>** Note that the traversal order of unsorted bin is bk. **</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="c1">// If the unsorted bin is not empty</span>
<span class="w">        </span><span class="c1">// First In First Out</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">)</span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// victim is the last chunk of unsorted bin</span>
<span class="w">            </span><span class="c1">// bck is the penultimate chunk of unsorted bin</span>
<span class="w">            </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// Determine whether the obtained chunk meets the requirements, can not be too small, can not be too large</span>
<span class="w">            </span><span class="c1">// The size of the general system_mem is 132K</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">victim</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">                </span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">victim</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">                </span><span class="n">malloc_printerr</span><span class="p">(</span><span class="n">check_action</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;malloc(): memory corruption&quot;</span><span class="p">,</span>
<span class="w">                                </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">),</span><span class="w"> </span><span class="n">av</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Get the chunk size corresponding to the victim.</span>
<span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
</code></pre></div>
<h5 id="small-request">small request<a class="headerlink" href="#small-request" title="Permanent link">&para;</a></h5>
<p>If the user's request is a small bin chunk, then we first consider the last remainder. If the last remainder is the only one in the unsorted bin, and the size of the last remainder is enough to be a chunk, why is there no equal sign**?</p>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="cm">/*</span>
<span class="cm">               If a small request, try to use last remainder if it is the</span>
<span class="cm">               only chunk in unsorted bin.  This helps promote locality for</span>
<span class="cm">               runs of consecutive small requests. This is the only</span>
<span class="cm">               exception to best-fit, and applies only when there is</span>
<span class="cm">               no exact fit for a small chunk.</span>
<span class="cm">             */</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">bck</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="n">victim</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">last_remainder</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="cm">/* split and reattach remainder */</span>
<span class="w">                </span><span class="c1">// Get the size of the new retriever</span>
<span class="w">                </span><span class="n">remainder_size</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span>
<span class="w">                </span><span class="c1">// Get the location of the new retriever</span>
<span class="w">                </span><span class="n">remainder</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// update the unsorted bin</span>
<span class="w">                </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="w">                </span><span class="c1">// update the last_remainder recorded in av</span>
<span class="w">                </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">last_remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="w">                </span><span class="c1">// Update the pointer of the last remainder</span>
<span class="w">                </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">remainder_size</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                    </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">// Set the victim&#39;s head,</span>
<span class="w">                </span><span class="n">set_head</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                    </span><span class="p">(</span><span class="n">av</span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="o">?</span><span class="w"> </span><span class="n">NON_MAIN_ARENA</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">                </span><span class="c1">// Set the head of the remainder</span>
<span class="w">                </span><span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Set the prev_size field of the record remainder size because the retriever is idle at this time.</span>
<span class="w">                </span><span class="n">set_foot</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Detailed inspection, no effect in non-debug mode</span>
<span class="w">                </span><span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Convert victim from chunk mode to mem mode</span>
<span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff</span>
<span class="w">                </span><span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
</code></pre></div>
<h5 id="initial-take-out">Initial take out<a class="headerlink" href="#initial-take-out" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="cm">/* remove from unsorted list */</span>
<span class="w">            </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
<span class="w">            </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
</code></pre></div>
<h5 id="exact-fit">exact fit<a class="headerlink" href="#exact-fit" title="Permanent link">&para;</a></h5>
<p>If the chunk size taken from the unsorted bin is just right, use it directly. Here we should have allocated the appropriate chunks after the merger.</p>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="cm">/* Take now instead of binning if exact fit */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">set_inuse_bit_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span><span class="w"> </span><span class="n">set_non_main_arena</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">                </span><span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">                </span><span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
</code></pre></div>
<h5 id="place-chunk-in-small-bin">place chunk in small bin<a class="headerlink" href="#place-chunk-in-small-bin" title="Permanent link">&para;</a></h5>
<p>Put the extracted chunk into the corresponding small bin.</p>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="cm">/* place chunk in bin */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">size</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">victim_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smallbin_index</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="w">                </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim_index</span><span class="p">);</span>
<span class="w">                </span><span class="n">fwd</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
</code></pre></div>
<h5 id="place-chunk-in-large-bin">place chunk in large bin<a class="headerlink" href="#place-chunk-in-large-bin" title="Permanent link">&para;</a></h5>
<p>Put the fetched chunks into the corresponding large bin.</p>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// large bin range</span>
<span class="w">                </span><span class="n">victim_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">largebin_index</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="w">                </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim_index</span><span class="p">);</span><span class="w"> </span><span class="c1">// the head of the current large bin</span>
<span class="w">                </span><span class="n">fwd</span><span class="w">          </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>

<span class="w">                </span><span class="cm">/* maintain large bins in sorted order */</span>
<span class="w">                </span><span class="cm">/* From here we can conclude that largebin is sorted in descending order by fd_nextsize.</span>
<span class="cm">                The same size chunk, later will only be inserted into the same size chunk before.</span>
<span class="cm">                It is easy to understand without modifying the same size fd/bk_nextsize.</span>
<span class="cm">                Can reduce overhead. In addition, the bin header does not participate in the nextsize link. */</span>
<span class="w">                </span><span class="c1">// If the large bin list is not empty</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fwd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bck</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="cm">/* Or with inuse bit to speed comparisons */</span>
<span class="w">                    </span><span class="c1">// Accelerate comparisons, not only should this be considered, because the chunks in the list will set this bit.</span>
<span class="w">                    </span><span class="n">size</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">;</span>
<span class="w">                    </span><span class="cm">/* if smaller than smallest, bypass loop below */</span>
<span class="w">                    </span><span class="c1">// bck-&gt;bk stores the smallest chunk in the corresponding large bin.</span>
<span class="w">                    </span><span class="c1">// If the traversed chunk is smaller than the current minimum, then it only needs to be inserted at the end of the list.</span>
<span class="w">                    </span><span class="c1">// Determine if bck-&gt;bk is in main arena.</span>
<span class="w">                    </span><span class="n">assert</span><span class="p">(</span><span class="n">chunk_main_arena</span><span class="p">(</span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">));</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span>
<span class="w">                        </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// Let fwd point to the big bin header</span>
<span class="w">                        </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
<span class="w">                        </span><span class="c1">// Let bck point to the largin bin tail chunk</span>
<span class="w">                        </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
<span class="w">                        </span><span class="c1">// victim&#39;s fd_nextsize points to the first chunk of largin bin</span>
<span class="w">                        </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
<span class="w">                        </span><span class="c1">// victim&#39;s bk_nextsize points to the bk_nextsize pointed to by the first chunk of the original list.</span>
<span class="w">                        </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
<span class="w">                        </span><span class="c1">// The bk_nextsize of the first chunk of the original list points to the victim</span>
<span class="w">                        </span><span class="c1">// The original fd_nextsize pointing to the first chunk of the list points to victim</span>
<span class="w">                        </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="c1">// The size of the victim currently being inserted is larger than the smallest chunk</span>
<span class="w">                        </span><span class="c1">// Determine if fwd is in main arena</span>
<span class="w">                        </span><span class="n">assert</span><span class="p">(</span><span class="n">chunk_main_arena</span><span class="p">(</span><span class="n">fwd</span><span class="p">));</span>
<span class="w">                        </span><span class="c1">// Start from the head of the list to find a chunk that is no bigger than the victim.</span>
<span class="w">                        </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">fwd</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="p">;</span>
<span class="w">                            </span><span class="n">assert</span><span class="p">(</span><span class="n">chunk_main_arena</span><span class="p">(</span><span class="n">fwd</span><span class="p">));</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                        </span><span class="c1">// If you find a chunk that is as big as the victim,</span>
<span class="w">                        </span><span class="c1">// Then insert the chunk directly after the chunk and don&#39;t modify the nextsize pointer.</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">==</span>
<span class="w">                            </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">fwd</span><span class="p">))</span>
<span class="w">                            </span><span class="cm">/* Always insert in the second position.  */</span>
<span class="w">                            </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
<span class="w">                        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="c1">// If the chunk found is not the same size as the current victim</span>
<span class="w">                            </span><span class="c1">// Then you need to construct a nextsize doubly linked list.</span>
<span class="w">                            </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span>
<span class="w">                            </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
<span class="w">                            </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
<span class="w">                            </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                        </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span>
<span class="w">                    </span><span class="c1">// If it is empty, simply make fd_nextsize and bk_nextsize form a doubly linked list.</span>
<span class="w">                    </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>

<span class="w">            </span><span class="p">}</span>
</code></pre></div>
<h5 id="final-take-out">Final take out<a class="headerlink" href="#final-take-out" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="c1">// Put it in the corresponding bin to form bck&lt;--&gt;victim&lt;--&gt;fwd.</span>
<span class="w">            </span><span class="n">mark_bin</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim_index</span><span class="p">);</span>
<span class="w">            </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
<span class="w">            </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span>
<span class="w">            </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
<span class="w">            </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="p">;</span>
</code></pre></div>
<h5 id="while-iterations">while Iterations<a class="headerlink" href="#while-iterations" title="Permanent link">&para;</a></h5>
<p>While exits up to 10,000 iterations and exits.</p>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="c1">// # define MAX_ITERS 10000</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">iters</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_ITERS</span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
</code></pre></div>
<h4 id="large-chunk">large chunk<a class="headerlink" href="#large-chunk" title="Permanent link">&para;</a></h4>
<p>**Note: It may be very strange, why not go to see if the small chunk meets the new requirements first? This is because the small bin has already been judged before the loop. If there is one, the chunk will appear after the merge. But outside the big loop, the large chunk simply finds its index, so it feels reasonable to judge directly here, and also to find larger chunks for the following. **</p>
<p>If the requested chunk is in the large chunk range, it is scanned from small to large in the corresponding bin to find the first one.</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="cm">/*</span>
<span class="cm">           If a large request, scan through the chunks of current bin in</span>
<span class="cm">           sorted order to find smallest that fits.  Use the skip list for this.</span>
<span class="cm">         */</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">nb</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
<span class="w">            </span><span class="cm">/* skip scan if empty or largest chunk is too small */</span>
<span class="w">            </span><span class="c1">// If the corresponding bin is empty or the chunks in it are the smallest, skip it</span>
<span class="w">            </span><span class="c1">// first(bin)=bin-&gt;fd means the largest chunk in the current list.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">(</span><span class="n">bin</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bin</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">victim</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span>
<span class="w">                    </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Reverse traversing the list until the first chunk is found that is not less than the desired chunk size</span>
<span class="w">                </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
<span class="w">                </span><span class="k">while</span><span class="w"> </span><span class="p">(((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span>
<span class="w">                        </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">)))</span>
<span class="w">                    </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>

<span class="w">                </span><span class="cm">/* Avoid removing the first entry for a size so that the skip</span>
<span class="cm">                   list does not have to be rerouted.  */</span>
<span class="w">                </span><span class="c1">// If the final chunk is not the last chunk in the bin, and the chunk is in front of the chunk</span>
<span class="w">                </span><span class="c1">// The size is the same, then we take the chunk in front of it, so we can avoid adjusting bk_nextsize, fd_nextsize</span>
<span class="w">                </span><span class="c1">// linked list. Because only one chunk of the same size will be chained to the nextsize chain.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">last</span><span class="p">(</span><span class="n">bin</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                    </span><span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">victim</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">chunksize_nomask</span><span class="p">(</span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">))</span>
<span class="w">                    </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
<span class="w">                </span><span class="c1">// Calculate the remaining size after the allocation</span>
<span class="w">                </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span>
<span class="w">                </span><span class="c1">// unlink</span>
<span class="w">                </span><span class="n">unlink</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">bck</span><span class="p">,</span><span class="w"> </span><span class="n">fwd</span><span class="p">);</span>
<span class="w">                </span><span class="cm">/* Exhaust */</span>
<span class="w">                </span><span class="c1">// The remaining size is not enough to be a block</span>
<span class="w">                </span><span class="c1">// Very curious what will happen next?</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remainder_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">set_inuse_bit_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span><span class="w"> </span><span class="n">set_non_main_arena</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="cm">/* Split */</span>
<span class="w">                </span><span class="c1">// The remaining size can also be split as a chunk.</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Get the pointer to the remaining chunk, called the reducer</span>
<span class="w">                    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">                    </span><span class="cm">/* We cannot assume the unsorted list is empty and therefore</span>
<span class="cm">                       have to perform a complete insert here.  */</span>
<span class="w">                    </span><span class="c1">// Insert in unsorted bin</span>
<span class="w">                    </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
<span class="w">                    </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>

<span class="w">                    </span><span class="c1">// Determine if the unsorted bin is destroyed.</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="p">(</span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bck</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">errstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;malloc(): corrupted unsorted chunks&quot;</span><span class="p">;</span>
<span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">errout</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
<span class="w">                    </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span>
<span class="w">                    </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="w">                    </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="w">                    </span><span class="c1">// If it is not in the range of small bin, set the corresponding field</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">remainder_size</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                        </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>

<span class="w">                    </span><span class="c1">// Set the flag of the assigned chunk</span>
<span class="w">                    </span><span class="n">set_head</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span>
<span class="w">                             </span><span class="n">nb</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                </span><span class="p">(</span><span class="n">av</span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="o">?</span><span class="w"> </span><span class="n">NON_MAIN_ARENA</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">                    </span><span class="c1">// Set the last chunk of the remainder, that is, the usage status of the allocated chunk</span>
<span class="w">                    </span><span class="c1">// The rest of the rules are inherited directly from above.</span>
<span class="w">                    </span><span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">                    </span><span class="c1">// Set the size of the remainder</span>
<span class="w">                    </span><span class="n">set_foot</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">// an examination</span>
<span class="w">                </span><span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Convert to mem state</span>
<span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff</span>
<span class="w">                </span><span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<h4 id="looking-for-a-larger-chunk">Looking for a larger chunk<a class="headerlink" href="#looking-for-a-larger-chunk" title="Permanent link">&para;</a></h4>
<p>If you get here, it means that for the chunks that the user needs, you can't get the chunk directly from the corresponding bin, so we need to find the faster bin, small bin or large bin larger than the current bin.</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="cm">/*</span>
<span class="cm">           Search for a chunk by scanning bins, starting with next largest</span>
<span class="cm">           bin. This search is strictly by best-fit; i.e., the smallest</span>
<span class="cm">           (with ties going to approximately the least recently used) chunk</span>
<span class="cm">           that fits is selected.</span>

<span class="cm">           The bitmap avoids needing to check that most blocks are nonempty.</span>
<span class="cm">           The particular case of skipping all bins during warm-up phases</span>
<span class="cm">           when no chunks have been returned yet is faster than it might look.</span>
<span class="cm">         */</span>

<span class="w">        </span><span class="o">++</span><span class="n">idx</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Get the corresponding bin</span>
<span class="w">        </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Get the current index in the binmap block index</span>
<span class="w">        </span><span class="c1">// #define idx2block(i) ((i) &gt;&gt; BINMAPSHIFT)  ,BINMAPSHIFT=5</span>
<span class="w">        </span><span class="c1">// Binmap is managed by block. Each block is an int with a total of 32 bits. It can indicate whether there are free chunks in 32 bins.</span>
<span class="w">        </span><span class="c1">// So here is the right shift 5</span>
<span class="w">        </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idx2block</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// Get the mapping corresponding to the current block size, here you can know whether there is a free block in the corresponding bin</span>
<span class="w">        </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">binmap</span><span class="w"> </span><span class="p">[</span><span class="n">block</span><span class="p">];</span>
<span class="w">        </span><span class="c1">// #define idx2bit(i) ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1))))</span>
<span class="w">        </span><span class="c1">// Set the bit corresponding to idx to 1, and the other bits to 0.</span>
<span class="w">        </span><span class="n">bit</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">idx2bit</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(;;)</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<h5 id="find-a-suitable-map">Find a suitable map<a class="headerlink" href="#find-a-suitable-map" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="cm">/* Skip rest of block if there are no more set bits in this block.</span>
<span class="cm">             */</span>

<span class="w">            </span><span class="c1">// If bit&gt;map, it means that there is no free block in the map that is larger than the current required chunk.</span>
<span class="w">            </span><span class="c1">// If the bit is 0, then the parameter brought by idx2bit above is 0.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">bit</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Find the next block until its corresponding map is not 0.</span>
<span class="w">                    </span><span class="c1">// If it doesn&#39;t exist, you can only use the top chunk.</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">++</span><span class="n">block</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">BINMAPSIZE</span><span class="p">)</span><span class="w"> </span><span class="cm">/* out of bins */</span>
<span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">use_top</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">binmap</span><span class="p">[</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// Get its corresponding bin, because the chunk size in the map is larger than the required chunk, and</span>
<span class="w">                </span><span class="c1">// map itself is not 0, so there must be a chunk that meets the requirements.</span>
<span class="w">                </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bin_at</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">block</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">BINMAPSHIFT</span><span class="p">));</span>
<span class="w">                </span><span class="n">bit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
</code></pre></div>
<h5 id="find-the-right-bin">Find the right bin<a class="headerlink" href="#find-the-right-bin" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="cm">/* Advance to bin with set bit. There must be one. */</span>

<span class="w">            </span><span class="c1">// Find from the smallest bin of the current map until you find the appropriate bin.</span>
<span class="w">            </span><span class="c1">// This is definitely there.</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">bit</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">map</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_bin</span><span class="p">(</span><span class="n">bin</span><span class="p">);</span>
<span class="w">                </span><span class="n">bit</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">assert</span><span class="p">(</span><span class="n">bit</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
</code></pre></div>
<h5 id="simple-check-chunk">Simple check chunk<a class="headerlink" href="#simple-check-chunk" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="cm">/* Inspect the bin. It is likely to be non-empty */</span>

<span class="w">            </span><span class="c1">// Get the corresponding bin</span>
<span class="w">            </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">last</span><span class="p">(</span><span class="n">bin</span><span class="p">);</span>

<span class="w">            </span><span class="cm">/*  If a false alarm(empty bin), clear the bit. */</span>
<span class="w">            </span><span class="c1">// If victim=bin, then we clear the bit corresponding to the map to 0 and then get the next bin.</span>
<span class="w">            </span><span class="c1">// The probability of this happening should be small.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">victim</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">bin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">binmap</span><span class="p">[</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">bit</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Write through */</span>
<span class="w">                </span><span class="n">bin</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="n">next_bin</span><span class="p">(</span><span class="n">bin</span><span class="p">);</span>
<span class="w">                </span><span class="n">bit</span><span class="w"> </span><span class="o">&lt;&lt;=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
</code></pre></div>
<h5 id="really-take-out-chunk">Really take out chunk<a class="headerlink" href="#really-take-out-chunk" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// Get the size of the corresponding victim</span>
<span class="w">                </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>

<span class="w">                </span><span class="cm">/*  We know the first chunk in this bin is big enough to use. */</span>
<span class="w">                </span><span class="n">assert</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="p">));</span>
<span class="w">                </span><span class="c1">// Calculate the remaining size after splitting</span>
<span class="w">                </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span>

<span class="w">                </span><span class="cm">/* unlink */</span>
<span class="w">                </span><span class="n">unlink</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">bck</span><span class="p">,</span><span class="w"> </span><span class="n">fwd</span><span class="p">);</span>

<span class="w">                </span><span class="cm">/* Exhaust */</span>
<span class="w">                </span><span class="c1">// What if there is not enough chunk after splitting?</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remainder_size</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">set_inuse_bit_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span><span class="w"> </span><span class="n">set_non_main_arena</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="cm">/* Split */</span>
<span class="w">                </span><span class="c1">// If enough, despite the segmentation</span>
<span class="w">                </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// Calculate the offset of the remaining chunk</span>
<span class="w">                    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>

<span class="w">                    </span><span class="cm">/* We cannot assume the unsorted list is empty and therefore</span>
<span class="cm">                       have to perform a complete insert here.  */</span>

<span class="w">                    </span><span class="c1">// Insert the remaining chunks into the unsorted bin</span>
<span class="w">                    </span><span class="n">bck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unsorted_chunks</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
<span class="w">                    </span><span class="n">fwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__glibc_unlikely</span><span class="p">(</span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bck</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">errstr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;malloc(): corrupted unsorted chunks 2&quot;</span><span class="p">;</span>
<span class="w">                        </span><span class="k">goto</span><span class="w"> </span><span class="n">errout</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bck</span><span class="p">;</span>
<span class="w">                    </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fwd</span><span class="p">;</span>
<span class="w">                    </span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="w">                    </span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>

<span class="w">                    </span><span class="cm">/* advertise as last remainder */</span>
<span class="w">                    </span><span class="c1">// If it is in the range of small bin, mark it as a remainder</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">nb</span><span class="p">))</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">last_remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">remainder_size</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                        </span><span class="n">remainder</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="c1">// Set the use status of the victim</span>
<span class="w">                    </span><span class="n">set_head</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span>
<span class="w">                             </span><span class="n">nb</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                </span><span class="p">(</span><span class="n">av</span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="o">?</span><span class="w"> </span><span class="n">NON_MAIN_ARENA</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">                    </span><span class="c1">// Set the usage status of the remainder. Why is this?</span>
<span class="w">                    </span><span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">                    </span><span class="c1">// Set the size of the remainder</span>
<span class="w">                    </span><span class="n">set_foot</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="c1">// an examination</span>
<span class="w">                </span><span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// The chunk state is converted to the mem state.</span>
<span class="w">                </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">                </span><span class="c1">// If perturb_type is set, the obtained chunk is initialized to perturb_type ^ 0xff</span>
<span class="w">                </span><span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
</code></pre></div>
<h3 id="using-top-chunk">Using top chunk<a class="headerlink" href="#using-top-chunk" title="Permanent link">&para;</a></h3>
<p>If all the chunks in the bin have no way to directly meet the requirements (that is, not merged), or there are no free chunks. Then we can only use the top chunk.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nl">use_top</span><span class="p">:</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">           If large enough, split off the chunk bordering the end of memory</span>
<span class="cm">           (held in av-&gt;top). Note that this is in accord with the best-fit</span>
<span class="cm">           search rule.  In effect, av-&gt;top is treated as larger (and thus</span>
<span class="cm">           less well fitting) than any other available chunk since it can</span>
<span class="cm">           be extended to be as large as necessary (up to system</span>
<span class="cm">           limitations).</span>

<span class="cm">           We require that av-&gt;top always exists (i.e., has size &gt;=</span>
<span class="cm">           MINSIZE) after initialization, so if it would otherwise be</span>
<span class="cm">           exhausted by current request, it is replenished. (The main</span>
<span class="cm">           reason for ensuring it exists is that we may need MINSIZE space</span>
<span class="cm">           to put in fenceposts in sysmalloc.)</span>
<span class="cm">         */</span>

<span class="w">        </span><span class="c1">// Get the current top chunk and calculate its corresponding size</span>
<span class="w">        </span><span class="n">victim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
<span class="w">        </span><span class="n">size</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// If the top chunk size still satisfies the minimum size of chunk after splitting, then you can split directly.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">nb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span>
<span class="w">            </span><span class="n">remainder</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">            </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="w">            </span><span class="c1">// Here, set PREV_INUSE because if the previous chunk of the top chunk is bound to be fastbin,</span>
<span class="w">            </span><span class="c1">// The top chunk will merged, so PREV_INUSE is set here.</span>
<span class="w">            </span><span class="n">set_head</span><span class="p">(</span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                </span><span class="p">(</span><span class="n">av</span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="o">?</span><span class="w"> </span><span class="n">NON_MAIN_ARENA</span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">            </span><span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">            </span><span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">victim</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">victim</span><span class="p">);</span>
<span class="w">            </span><span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// Otherwise, determine if there is a fast chunk</span>
<span class="w">        </span><span class="cm">/* When we are using atomic ops to free fast chunks we can get</span>
<span class="cm">           here for all block sizes.  */</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">have_fastchunks</span><span class="p">(</span><span class="n">av</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Perform a fast bin merge first</span>
<span class="w">            </span><span class="n">malloc_consolidate</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
<span class="w">            </span><span class="cm">/* restore original bin index */</span>
<span class="w">            </span><span class="c1">// Determine whether the required chunk is in the range of small bin or large bin</span>
<span class="w">            </span><span class="c1">// and calculate the corresponding index</span>
<span class="w">            </span><span class="c1">// Wait for the next time to see if you can</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">in_smallbin_range</span><span class="p">(</span><span class="n">nb</span><span class="p">))</span>
<span class="w">                </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smallbin_index</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">largebin_index</span><span class="p">(</span><span class="n">nb</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<h3 id="heap-memory-is-not-enough">Heap memory is not enough<a class="headerlink" href="#heap-memory-is-not-enough" title="Permanent link">&para;</a></h3>
<p>If the heap memory is not enough, we need to use <code>sysmalloc</code> to apply for memory.</p>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="cm">/*</span>
<span class="cm">           Otherwise, relay to handle system-dependent cases</span>
<span class="cm">         */</span>

<span class="w">        </span><span class="c1">// Otherwise, we can only apply for a bit of memory from the system again.</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysmalloc</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span><span class="w"> </span><span class="n">av</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="n">alloc_perturb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<h2 id="_libc_calloc">_libc_calloc<a class="headerlink" href="#_libc_calloc" title="Permanent link">&para;</a></h2>
<p>Calloc is also a function in libc that requests memory blocks. The package in <code>libc</code> is <code>_libc_calloc</code>, which is described below.</p>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">  calloc(size_t n_elements, size_t element_size);</span>
<span class="cm">  Returns a pointer to n_elements * element_size bytes, with all locations</span>
<span class="cm">  set to zero.</span>
<span class="cm">*/</span>
<span class="kt">void</span><span class="o">*</span><span class="w">  </span><span class="nf">__libc_calloc</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">);</span>
</code></pre></div>
<h2 id="sysmalloc">sysmalloc<a class="headerlink" href="#sysmalloc" title="Permanent link">&para;</a></h2>
<p>As the comment in the function header says, this function is used to request more memory from the system when the current heap is out of memory.</p>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm">   sysmalloc handles malloc cases requiring more memory from the system.</span>
<span class="cm">   On entry, it is assumed that av-&gt;top does not have enough</span>
<span class="cm">   space to service request for nb bytes, thus requiring that av-&gt;top</span>
<span class="cm">   be extended or replaced.</span>
<span class="cm"> */</span>
</code></pre></div>
<h3 id="basic-definition">Basic definition<a class="headerlink" href="#basic-definition" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">sysmalloc</span><span class="p">(</span><span class="n">INTERNAL_SIZE_T</span><span class="w"> </span><span class="n">nb</span><span class="p">,</span><span class="w"> </span><span class="n">mstate</span><span class="w"> </span><span class="n">av</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">old_top</span><span class="p">;</span><span class="w">        </span><span class="cm">/* incoming value of av-&gt;top */</span>
<span class="w">  </span><span class="n">INTERNAL_SIZE_T</span><span class="w"> </span><span class="n">old_size</span><span class="p">;</span><span class="w"> </span><span class="cm">/* its size */</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">old_end</span><span class="p">;</span><span class="w">            </span><span class="cm">/* its end address */</span>

<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="cm">/* arg to first MORECORE or mmap call */</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">brk</span><span class="p">;</span><span class="w"> </span><span class="cm">/* return value from MORECORE */</span>

<span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="n">correction</span><span class="p">;</span><span class="w"> </span><span class="cm">/* arg to 2nd MORECORE call */</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">snd_brk</span><span class="p">;</span><span class="w">   </span><span class="cm">/* 2nd return val */</span>

<span class="w">  </span><span class="n">INTERNAL_SIZE_T</span><span class="w"> </span><span class="n">front_misalign</span><span class="p">;</span><span class="w"> </span><span class="cm">/* unusable bytes at front of new space */</span>
<span class="w">  </span><span class="n">INTERNAL_SIZE_T</span><span class="w"> </span><span class="n">end_misalign</span><span class="p">;</span><span class="w">   </span><span class="cm">/* partial page left at end of new space */</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">aligned_brk</span><span class="p">;</span><span class="w">              </span><span class="cm">/* aligned offset into brk */</span>

<span class="w">  </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w">                  </span><span class="cm">/* the allocated/returned chunk */</span>
<span class="w">  </span><span class="n">mchunkptr</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span><span class="w">          </span><span class="cm">/* remainder frOm allocation */</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">remainder_size</span><span class="p">;</span><span class="w"> </span><span class="cm">/* its size */</span>

<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">pagesize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GLRO</span><span class="p">(</span><span class="n">dl_pagesize</span><span class="p">);</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">tried_mmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</code></pre></div>
<p>We can mainly focus on <code>pagesize</code>, which</p>
<div class="highlight"><pre><span></span><code><span class="cp">#ifndef EXEC_PAGESIZE</span>
<span class="cp">#define EXEC_PAGESIZE   4096</span>
<span class="cp">#endif</span>
<span class="cp"># define GLRO(name) _##name</span>
<span class="kt">size_t</span><span class="w"> </span><span class="n">_dl_pagesize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXEC_PAGESIZE</span><span class="p">;</span>
</code></pre></div>
<p>So, <code>pagesize=4096=0x1000</code>.</p>
<h3 id="consider-mmap">Consider mmap<a class="headerlink" href="#consider-mmap" title="Permanent link">&para;</a></h3>
<p>As stated in the opening comment, if any of the following conditions are met</p>
<ol>
<li>There is no heap allocated.</li>
<li>If the requested memory is larger than <code>mp_.mmap_threshold</code> and the number of mmap is less than the maximum value, you can try to use mmap.</li>
</ol>
<p>By default, the threshold is</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">malloc_par</span><span class="w"> </span><span class="n">mp_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">top_pad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_TOP_PAD</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">n_mmaps_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_MMAP_MAX</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">mmap_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_MMAP_THRESHOLD</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">trim_threshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEFAULT_TRIM_THRESHOLD</span><span class="p">,</span>
<span class="cp">#define NARENAS_FROM_NCORES(n) ((n) * (sizeof(long) == 4 ? 2 : 8))</span>
<span class="w">    </span><span class="p">.</span><span class="n">arena_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NARENAS_FROM_NCORES</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="cp">#if USE_TCACHE</span>
<span class="w">        </span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">tcache_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCACHE_FILL_COUNT</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">tcache_bins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TCACHE_MAX_BINS</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">tcache_max_bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tidx2usize</span><span class="p">(</span><span class="n">TCACHE_MAX_BINS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">tcache_unsorted_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cm">/* No limit.  */</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</code></pre></div>
<p><code>DEFAULT_MMAP_THRESHOLD</code> is 128*1024 bytes, or 128 K.</p>
<div class="highlight"><pre><span></span><code><span class="cp">#ifndef DEFAULT_MMAP_THRESHOLD</span>
<span class="cp">#define DEFAULT_MMAP_THRESHOLD DEFAULT_MMAP_THRESHOLD_MIN</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm">  MMAP_THRESHOLD_MAX and _MIN are the bounds on the dynamically</span>
<span class="cm">  adjusted MMAP_THRESHOLD.</span>
<span class="cm">*/</span>

<span class="cp">#ifndef DEFAULT_MMAP_THRESHOLD_MIN</span>
<span class="cp">#define DEFAULT_MMAP_THRESHOLD_MIN (128 * 1024)</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef DEFAULT_MMAP_THRESHOLD_MAX</span>
<span class="cm">/* For 32-bit platforms we cannot increase the maximum mmap</span>
<span class="cm">   threshold much because it is also the minimum value for the</span>
<span class="cm">   maximum heap size and its alignment.  Going above 512k (i.e., 1M</span>
<span class="cm">   for new heaps) wastes too much address space.  */</span>
<span class="cp">#if __WORDSIZE == 32</span>
<span class="cp">#define DEFAULT_MMAP_THRESHOLD_MAX (512 * 1024)</span>
<span class="cp">#else</span>
<span class="cp">#define DEFAULT_MMAP_THRESHOLD_MAX (4 * 1024 * 1024 * sizeof(long))</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
</code></pre></div>
<p>The following is part of the code, which is not the focus of our concern at present, and can be skipped temporarily.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="cm">/*</span>
<span class="cm">     If have mmap, and the request size meets the mmap threshold, and</span>
<span class="cm">     the system supports mmap, and there are few enough currently</span>
<span class="cm">     allocated mmapped regions, try to directly map this request</span>
<span class="cm">     rather than expanding top.</span>
<span class="cm">   */</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span>
<span class="w">      </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">nb</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">mp_</span><span class="p">.</span><span class="n">mmap_threshold</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="p">(</span><span class="n">mp_</span><span class="p">.</span><span class="n">n_mmaps</span><span class="w"> </span><span class="o">&lt;</span><span class="n">mp_</span><span class="p">.</span><span class="n">n_mmaps_max</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span><span class="w"> </span><span class="cm">/* return value from mmap call*/</span>

<span class="w">  </span><span class="nl">try_mmap</span><span class="p">:</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">       Round up size to nearest page.  For mmapped chunks, the overhead</span>
<span class="cm">       is one SIZE_SZ unit larger than for normal chunks, because there</span>
<span class="cm">       is no following chunk whose prev_size field could be used.</span>

<span class="cm">       See the front_misalign handling below, for glibc there is no</span>
<span class="cm">       need for further alignments unless we have have high alignment.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MALLOC_ALIGNMENT</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">)</span>
<span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN_UP</span><span class="p">(</span><span class="n">nb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">,</span><span class="w"> </span><span class="n">pagesize</span><span class="p">);</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN_UP</span><span class="p">(</span><span class="n">nb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">,</span><span class="w"> </span><span class="n">pagesize</span><span class="p">);</span>
<span class="w">    </span><span class="n">tried_mmap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* Don&#39;t try if size wraps around 0 */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">nb</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MMAP</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAP_FAILED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">           The offset to the start of the mmapped region is stored</span>
<span class="cm">           in the prev_size field of the chunk. This allows us to adjust</span>
<span class="cm">           returned start address to meet alignment requirements here</span>
<span class="cm">           and in memalign(), and still be able to compute proper</span>
<span class="cm">           address argument for later munmap in free() and realloc().</span>
<span class="cm">         */</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MALLOC_ALIGNMENT</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="cm">/* For glibc, chunk2mem increases the address by 2*SIZE_SZ and</span>
<span class="cm">             MALLOC_ALIGN_MASK is 2*SIZE_SZ-1.  Each mmap&#39;ed area is page</span>
<span class="cm">             aligned and therefore definitely MALLOC_ALIGN_MASK-aligned.  */</span>
<span class="w">          </span><span class="n">assert</span><span class="p">(((</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">          </span><span class="n">front_misalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span>
<span class="w">          </span><span class="n">front_misalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">front_misalign</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">correction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MALLOC_ALIGNMENT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">front_misalign</span><span class="p">;</span>
<span class="w">          </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mchunkptr</span><span class="p">)(</span><span class="n">mm</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">correction</span><span class="p">);</span>
<span class="w">          </span><span class="n">set_prev_size</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">correction</span><span class="p">);</span>
<span class="w">          </span><span class="n">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">correction</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">IS_MMAPPED</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mchunkptr</span><span class="p">)</span><span class="n">mm</span><span class="p">;</span>
<span class="w">          </span><span class="n">set_prev_size</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">          </span><span class="n">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">IS_MMAPPED</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="cm">/* update statistics */</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_exchange_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_</span><span class="p">.</span><span class="n">n_mmaps</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">atomic_max</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_</span><span class="p">.</span><span class="n">max_n_mmaps</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="p">);</span>

<span class="w">        </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
<span class="w">        </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_exchange_and_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_</span><span class="p">.</span><span class="n">mmapped_mem</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
<span class="w">        </span><span class="n">atomic_max</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp_</span><span class="p">.</span><span class="n">max_mmapped_mem</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">);</span>

<span class="w">        </span><span class="n">check_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h3 id="mmap-failed-or-unallocated-heap">mmap failed or unallocated heap<a class="headerlink" href="#mmap-failed-or-unallocated-heap" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="cm">/* There are no usable arenas and mmap also failed.  */</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>
<p>If it is any of these two situations, you can actually quit. .</p>
<h3 id="recording-old-heap-information">Recording old heap information<a class="headerlink" href="#recording-old-heap-information" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="cm">/* Record incoming configuration of top */</span>
<span class="w">  </span><span class="n">old_top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
<span class="w">  </span><span class="n">old_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="p">(</span><span class="n">old_top</span><span class="p">);</span>
<span class="w">  </span><span class="n">old_end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">old_size</span><span class="p">));</span>

<span class="w">  </span><span class="n">brk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snd_brk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">);</span>
</code></pre></div>
<h3 id="check-old-heap-information-1">Check old heap information 1<a class="headerlink" href="#check-old-heap-information-1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="cm">/*</span>
<span class="cm">     If not the first time through, we require old_size to be</span>
<span class="cm">     at least MINSIZE and to have prev_inuse set.</span>
<span class="cm">   */</span>

<span class="w">  </span><span class="n">assert</span><span class="p">((</span><span class="n">old_top</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">initial_top</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">old_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">||</span>
<span class="w">         </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">old_size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MINSIZE</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">prev_inuse</span><span class="p">(</span><span class="n">old_top</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">          </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">old_end</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">pagesize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
</code></pre></div>
<p>This check requires that any one of the conditions be met</p>
<ol>
<li><code>old_top == initial_top(av) &amp;&amp; old_size == 0</code>, ie if it is the first time, the heap size needs to be 0.</li>
<li>The new heap, then</li>
<li><code>(unsigned long)(old_size) &gt;= MINSIZE &amp;&amp; prev_inuse(old_top)</code>, the heap size should be no smaller than <code>MINSIZE</code>, and the previous heap block should be in use.</li>
<li><code>((unsigned long)old_end &amp;(pagesize - 1)) == 0)</code>, the end address of the heap should be page-aligned. Since the page alignment size defaults to 0x1000, the lower 12 bits need to be 0.</li>
</ol>
<h3 id="check-old-heap-information-2">Check old heap information 2<a class="headerlink" href="#check-old-heap-information-2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="cm">/* Precondition: not enough current space to satisfy nb request */</span>
<span class="w">  </span><span class="n">assert</span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">old_size</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">nb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">));</span>
</code></pre></div>
<p>According to the definition in malloc</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">_int_malloc</span><span class="p">(</span><span class="n">mstate</span><span class="w"> </span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">INTERNAL_SIZE_T</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span><span class="w">  </span><span class="cm">/* normalized request size */</span>
</code></pre></div>
<p><code>nb</code> should be the byte that has been added to the chunk header. Why add <code>MINSIZE</code>? This is because the size of the top chunk should at least reserve the MINSIZE space for easy merging.</p>
<h3 id="non-main_arena">Non main_arena<a class="headerlink" href="#non-main_arena" title="Permanent link">&para;</a></h3>
<p>This is not the focus of care for the time being, and it will not be analyzed for the time being.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">heap_info</span><span class="w"> </span><span class="o">*</span><span class="n">old_heap</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">heap</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">old_heap_size</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/* First try to extend the current heap. */</span>
<span class="w">    </span><span class="n">old_heap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap_for_ptr</span><span class="p">(</span><span class="n">old_top</span><span class="p">);</span>
<span class="w">    </span><span class="n">old_heap_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_heap</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">long</span><span class="p">)(</span><span class="n">MINSIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">grow_heap</span><span class="p">(</span><span class="n">old_heap</span><span class="p">,</span><span class="w"> </span><span class="n">MINSIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_size</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">old_heap</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_heap_size</span><span class="p">;</span>
<span class="w">      </span><span class="n">set_head</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span>
<span class="w">               </span><span class="p">(((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">old_heap</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">old_heap</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">old_top</span><span class="p">)</span><span class="w"> </span><span class="o">|</span>
<span class="w">                   </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">heap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_heap</span><span class="p">(</span><span class="n">nb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">MINSIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">heap</span><span class="p">)),</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">top_pad</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="cm">/* Use a newly allocated heap.  */</span>
<span class="w">      </span><span class="n">heap</span><span class="o">-&gt;</span><span class="n">ar_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">av</span><span class="p">;</span>
<span class="w">      </span><span class="n">heap</span><span class="o">-&gt;</span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_heap</span><span class="p">;</span>
<span class="w">      </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">heap</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<span class="w">      </span><span class="cm">/* Set up the new top.  */</span>
<span class="w">      </span><span class="n">top</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">heap</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">heap</span><span class="p">));</span>
<span class="w">      </span><span class="n">set_head</span><span class="p">(</span><span class="n">top</span><span class="p">(</span><span class="n">av</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">heap</span><span class="o">-&gt;</span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">heap</span><span class="p">))</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>

<span class="w">      </span><span class="cm">/* Setup fencepost and free the old top chunk with a multiple of</span>
<span class="cm">         MALLOC_ALIGNMENT in size. */</span>
<span class="w">      </span><span class="cm">/* The fencepost takes at least MINSIZE bytes, because it might</span>
<span class="cm">         become the top chunk again later.  Note that a footer is set</span>
<span class="cm">         up, too, although the chunk is marked in use. */</span>
<span class="w">      </span><span class="n">old_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">old_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">;</span>
<span class="w">      </span><span class="n">set_head</span><span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">old_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">),</span>
<span class="w">               </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_size</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">set_head</span><span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">old_size</span><span class="p">),</span>
<span class="w">                 </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">        </span><span class="n">set_foot</span><span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">old_size</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">));</span>
<span class="w">        </span><span class="n">set_head</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">old_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NON_MAIN_ARENA</span><span class="p">);</span>
<span class="w">        </span><span class="n">_int_free</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">set_head</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">old_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">        </span><span class="n">set_foot</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">old_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">));</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tried_mmap</span><span class="p">)</span>
<span class="w">      </span><span class="cm">/* We can at least try to use to mmap memory.  */</span>
<span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">try_mmap</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h3 id="main_arena-processing">Main_arena Processing<a class="headerlink" href="#main_arena-processing" title="Permanent link">&para;</a></h3>
<h4 id="calculating-memory">Calculating memory<a class="headerlink" href="#calculating-memory" title="Permanent link">&para;</a></h4>
<p>The calculation can satisfy the requested memory size.</p>
<div class="highlight"><pre><span></span><code><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="o">/</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">main_arena</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">/</span>

<span class="w">    </span><span class="cm">/* Request enough space for nb + pad + overhead */</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mp_</span><span class="p">.</span><span class="n">top_pad</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">;</span>
</code></pre></div>
<p>By default <code>top_pad</code> is defined as</p>
<div class="highlight"><pre><span></span><code><span class="cp">#ifndef DEFAULT_TOP_PAD</span>
<span class="cp"># define DEFAULT_TOP_PAD 131072</span>
<span class="cp">#endif</span>
</code></pre></div>
<p>That is, 131072 bytes, 0x20000 bytes.</p>
<h4 id="whether-it-is-continuous">Whether it is continuous<a class="headerlink" href="#whether-it-is-continuous" title="Permanent link">&para;</a></h4>
<p>If we want the heap space to be continuous, then we can actually reuse the previous memory.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cm">/*</span>
<span class="cm">       If contiguous, we can subtract out existing space that we hope to</span>
<span class="cm">       combine with new space. We add it back later only if</span>
<span class="cm">       we don&#39;t actually get contiguous space.</span>
<span class="cm">     */</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">contiguous</span><span class="p">(</span><span class="n">av</span><span class="p">))</span>
<span class="w">      </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">old_size</span><span class="p">;</span>
</code></pre></div>
<h4 id="align-page-size">Align page size<a class="headerlink" href="#align-page-size" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cm">/*</span>
<span class="cm">       Round to a multiple of page size.</span>
<span class="cm">       If MORECORE is not contiguous, this ensures that we only call it</span>
<span class="cm">       with whole-page arguments.  And if MORECORE is contiguous and</span>
<span class="cm">       this is not first time through, this preserves page-alignment of</span>
<span class="cm">       previous calls. Otherwise, we correct to page-align below.</span>

<span class="cm">     */</span>

<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN_UP</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">pagesize</span><span class="p">);</span>
</code></pre></div>
<h4 id="applying-for-memory">Applying for memory<a class="headerlink" href="#applying-for-memory" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="cm">/*</span>
<span class="cm">       Don&#39;t try to call MORECORE if argument is so big as to appear</span>
<span class="cm">       negative. Note that since mmap takes size_t arg, it may succeed</span>
<span class="cm">       below even if we cannot call MORECORE.</span>
<span class="cm">     */</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">brk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MORECORE</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
<span class="w">      </span><span class="n">LIBC_PROBE</span><span class="p">(</span><span class="n">memory_sbrk_more</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">brk</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h5 id="may-succeed">May succeed<a class="headerlink" href="#may-succeed" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brk</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="cm">/* Call the `morecore&#39; hook if necessary.  */</span>
<span class="w">      </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_forced_read</span><span class="p">(</span><span class="n">__after_morecore_hook</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">hook</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)();</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>It is a bit of a meaning to call a hook here.</p>
<h5 id="failed">Failed<a class="headerlink" href="#failed" title="Permanent link">&para;</a></h5>
<p>Failure, consider mmap.</p>
<div class="highlight"><pre><span></span><code><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="cm">/*</span>
<span class="cm">         If have mmap, try using it as a backup when MORECORE fails or</span>
<span class="cm">         cannot be used. This is worth doing on systems that have &quot;holes&quot; in</span>
<span class="cm">         address space, so sbrk cannot extend to give contiguous space, but</span>
<span class="cm">         space is available elsewhere.  Note that we ignore mmap max count</span>
<span class="cm">         and threshold limits, since the space will not be used as a</span>
<span class="cm">         segregated mmap region.</span>
<span class="cm">       */</span>

<span class="w">      </span><span class="cm">/* Cannot merge with old top, so add its size back in */</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">contiguous</span><span class="p">(</span><span class="n">av</span><span class="p">))</span>
<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALIGN_UP</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">old_size</span><span class="p">,</span><span class="w"> </span><span class="n">pagesize</span><span class="p">);</span>

<span class="w">      </span><span class="cm">/* If we are relying on mmap as backup, then use larger units */</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">MMAP_AS_MORECORE_SIZE</span><span class="p">))</span>
<span class="w">        </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MMAP_AS_MORECORE_SIZE</span><span class="p">;</span>

<span class="w">      </span><span class="cm">/* Don&#39;t try if size wraps around 0 */</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">nb</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">mbrk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MMAP</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mbrk</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAP_FAILED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="cm">/* We do not need, and cannot use, another sbrk call to find end */</span>
<span class="w">          </span><span class="n">brk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mbrk</span><span class="p">;</span>
<span class="w">          </span><span class="n">snd_brk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>

<span class="w">          </span><span class="cm">/*</span>
<span class="cm">             Record that we no longer have a contiguous sbrk region.</span>
<span class="cm">             After the first time mmap is used as backup, we do not</span>
<span class="cm">             ever rely on contiguous space since this could incorrectly</span>
<span class="cm">             bridge regions.</span>
<span class="cm">           */</span>

<span class="w">          </span><span class="n">set_noncontiguous</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="p">}</span>

<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h4 id="memory-may-be-applied-successfully">Memory may be applied successfully<a class="headerlink" href="#memory-may-be-applied-successfully" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brk</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mp_</span><span class="p">.</span><span class="n">sbrk_base</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="n">mp_srk_base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brk</span><span class="p">;</span>
<span class="w">        </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</code></pre></div>
<h5 id="situation-1">Situation 1<a class="headerlink" href="#situation-1" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">      </span><span class="cm">/*</span>
<span class="cm">         If MORECORE extends previous space, we can likewise extend top size.</span>
<span class="cm">       */</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">brk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">old_end</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">snd_brk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span>
<span class="w">        </span><span class="n">set_head</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">old_size</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
</code></pre></div>
<h5 id="case-2-unexpected-memory-exhaustion">Case 2 - Unexpected memory exhaustion<a class="headerlink" href="#case-2-unexpected-memory-exhaustion" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">contiguous</span><span class="p">(</span><span class="n">av</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">old_size</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">brk</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">old_end</span><span class="p">)</span>
<span class="w">        </span><span class="cm">/* Oops!  Someone else killed our space..  Can&#39;t touch anything.  */</span>
<span class="w">        </span><span class="n">malloc_printerr</span><span class="p">(</span><span class="s">&quot;break adjusted to free malloc space&quot;</span><span class="p">);</span>
</code></pre></div>
<h5 id="handling-other-unexpected-situations">Handling other unexpected situations<a class="headerlink" href="#handling-other-unexpected-situations" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">      </span><span class="cm">/*</span>
<span class="cm">         Otherwise, make adjustments:</span>

<span class="cm">       * If the first time through or noncontiguous, we need to call sbrk</span>
<span class="cm">          just to find out where the end of memory lies.</span>

<span class="cm">       * We need to ensure that all returned chunks from malloc will meet</span>
<span class="cm">          MALLOC_ALIGNMENT</span>

<span class="cm">       * If there was an intervening foreign sbrk, we need to adjust sbrk</span>
<span class="cm">          request size to account for fact that we will not be able to</span>
<span class="cm">          combine new space with existing space in old_top.</span>

<span class="cm">       * Almost all systems internally allocate whole pages at a time, in</span>
<span class="cm">          which case we might as well use the whole last page of request.</span>
<span class="cm">          So we allocate enough more memory to hit a page boundary now,</span>
<span class="cm">          which in turn causes future contiguous calls to page-align.</span>
<span class="cm">       */</span>

<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">front_misalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">end_misalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">correction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="n">aligned_brk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brk</span><span class="p">;</span>
</code></pre></div>
<h6 id="processing-contiguous-memory">Processing contiguous memory<a class="headerlink" href="#processing-contiguous-memory" title="Permanent link">&para;</a></h6>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="cm">/* handle contiguous cases */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">contiguous</span><span class="p">(</span><span class="n">av</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="cm">/* Count foreign sbrk as system_mem.  */</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_size</span><span class="p">)</span>
<span class="w">            </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">brk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">old_end</span><span class="p">;</span>

<span class="w">          </span><span class="cm">/* Guarantee alignment of first new chunk made from this space */</span>

<span class="w">          </span><span class="n">front_misalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">brk</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">front_misalign</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/*</span>
<span class="cm">               Skip over some bytes to arrive at an aligned position.</span>
<span class="cm">               We don&#39;t need to specially mark these wasted front bytes.</span>
<span class="cm">               They will never be accessed anyway because</span>
<span class="cm">               prev_inuse of av-&gt;top (and any chunk created from its start)</span>
<span class="cm">               is always true after initialization.</span>
<span class="cm">             */</span>

<span class="w">            </span><span class="n">correction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MALLOC_ALIGNMENT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">front_misalign</span><span class="p">;</span>
<span class="w">            </span><span class="n">aligned_brk</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">correction</span><span class="p">;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="cm">/*</span>
<span class="cm">             If this isn&#39;t adjacent to existing space, then we will not</span>
<span class="cm">             be able to merge with old_top space, so must add to 2nd request.</span>
<span class="cm">           */</span>

<span class="w">          </span><span class="n">correction</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">old_size</span><span class="p">;</span>

<span class="w">          </span><span class="cm">/* Extend the end address to hit a page boundary */</span>
<span class="w">          </span><span class="n">end_misalign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)(</span><span class="n">brk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">correction</span><span class="p">);</span>
<span class="w">          </span><span class="n">correction</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="n">ALIGN_UP</span><span class="p">(</span><span class="n">end_misalign</span><span class="p">,</span><span class="w"> </span><span class="n">pagesize</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end_misalign</span><span class="p">;</span>

<span class="w">          </span><span class="n">assert</span><span class="p">(</span><span class="n">correction</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">          </span><span class="n">snd_brk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MORECORE</span><span class="p">(</span><span class="n">correction</span><span class="p">));</span>

<span class="w">          </span><span class="cm">/*</span>
<span class="cm">             If can&#39;t allocate correction, try to at least find out current</span>
<span class="cm">             brk.  It might be enough to proceed without failing.</span>

<span class="cm">             Note that if second sbrk did NOT fail, we assume that space</span>
<span class="cm">             is contiguous with first sbrk. This is a safe assumption unless</span>
<span class="cm">             program is multithreaded but doesn&#39;t use locks and a foreign sbrk</span>
<span class="cm">             occurred between our first and second calls.</span>
<span class="cm">           */</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">snd_brk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">correction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">snd_brk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">MORECORE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/* Call the `morecore&#39; hook if necessary.  */</span>
<span class="w">            </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atomic_forced_read</span><span class="p">(</span><span class="n">__after_morecore_hook</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">__builtin_expect</span><span class="p">(</span><span class="n">hook</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="o">*</span><span class="n">hook</span><span class="p">)();</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<h6 id="handling-discontinuous-memory">Handling discontinuous memory<a class="headerlink" href="#handling-discontinuous-memory" title="Permanent link">&para;</a></h6>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="cm">/* handle non-contiguous cases */</span>
<span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">MALLOC_ALIGNMENT</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">)</span>
<span class="w">            </span><span class="cm">/* MORECORE/mmap must correctly align */</span>
<span class="w">            </span><span class="n">assert</span><span class="p">(((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">brk</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">front_misalign</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="p">(</span><span class="n">INTERNAL_SIZE_T</span><span class="p">)</span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">brk</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">front_misalign</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="cm">/*</span>
<span class="cm">                 Skip over some bytes to arrive at an aligned position.</span>
<span class="cm">                 We don&#39;t need to specially mark these wasted front bytes.</span>
<span class="cm">                 They will never be accessed anyway because</span>
<span class="cm">                 prev_inuse of av-&gt;top (and any chunk created from its start)</span>
<span class="cm">                 is always true after initialization.</span>
<span class="cm">               */</span>

<span class="w">              </span><span class="n">aligned_brk</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">MALLOC_ALIGNMENT</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">front_misalign</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>

<span class="w">          </span><span class="cm">/* Find out current end of memory */</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">snd_brk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">snd_brk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">MORECORE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<h6 id="adjustment">Adjustment<a class="headerlink" href="#adjustment" title="Permanent link">&para;</a></h6>
<div class="highlight"><pre><span></span><code><span class="w">        </span><span class="cm">/* Adjust top based on results of second sbrk */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">snd_brk</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">MORECORE_FAILURE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mchunkptr</span><span class="p">)</span><span class="w"> </span><span class="n">aligned_brk</span><span class="p">;</span>
<span class="w">          </span><span class="n">set_head</span><span class="p">(</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">snd_brk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">aligned_brk</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">correction</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">          </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">correction</span><span class="p">;</span>

<span class="w">          </span><span class="cm">/*</span>
<span class="cm">             If not the first time through, we either have a</span>
<span class="cm">             gap due to foreign sbrk or a non-contiguous region.  Insert a</span>
<span class="cm">             double fencepost at old_top to prevent consolidation with space</span>
<span class="cm">             we don&#39;t own. These fenceposts are artificial chunks that are</span>
<span class="cm">             marked as inuse and are in any case too small to use.  We need</span>
<span class="cm">             two to make sizes and alignments work out.</span>
<span class="cm">           */</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_size</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/*</span>
<span class="cm">               Shrink old_top to insert fenceposts, keeping size a</span>
<span class="cm">               multiple of MALLOC_ALIGNMENT. We know there is at least</span>
<span class="cm">               enough space in old_top to do this.</span>
<span class="cm">             */</span>
<span class="w">            </span><span class="n">old_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">old_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">MALLOC_ALIGN_MASK</span><span class="p">;</span>
<span class="w">            </span><span class="n">set_head</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">old_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>

<span class="w">            </span><span class="cm">/*</span>
<span class="cm">               Note that the following assignments completely overwrite</span>
<span class="cm">               old_top when old_size was previously MINSIZE.  This is</span>
<span class="cm">               intentional. We need the fencepost, even if old_top otherwise</span>
<span class="cm">               gets lost.</span>
<span class="cm">             */</span>
<span class="w">            </span><span class="n">set_head</span><span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">old_size</span><span class="p">),</span>
<span class="w">                     </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">            </span><span class="n">set_head</span><span class="p">(</span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="n">old_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">),</span>
<span class="w">                     </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SIZE_SZ</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>

<span class="w">            </span><span class="cm">/* If possible, release the rest. */</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">old_size</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="n">_int_free</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">old_top</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
</code></pre></div>
<p>It should be noted that here the program releases the old top chunk, and it will enter different bins or tcaches depending on the size.</p>
<h4 id="update-maximum-memory">Update maximum memory<a class="headerlink" href="#update-maximum-memory" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="o">-&gt;</span><span class="n">max_system_mem</span><span class="p">))</span>
<span class="w">    </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">max_system_mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">system_mem</span><span class="p">;</span>
<span class="w">  </span><span class="n">check_malloc_state</span><span class="p">(</span><span class="n">av</span><span class="p">);</span>
</code></pre></div>
<h4 id="allocating-memory-blocks">Allocating memory blocks<a class="headerlink" href="#allocating-memory-blocks" title="Permanent link">&para;</a></h4>
<h5 id="get-the-size">Get the size<a class="headerlink" href="#get-the-size" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="cm">/* finally, do the allocation */</span>
<span class="w">  </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
<span class="w">  </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunksize</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</code></pre></div>
<h5 id="top">切分 top<a class="headerlink" href="#top" title="Permanent link">&para;</a></h5>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="cm">/* check that one of the above allocation paths succeeded */</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)(</span><span class="n">nb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MINSIZE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">nb</span><span class="p">;</span>
<span class="w">    </span><span class="n">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chunk_at_offset</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">    </span><span class="n">av</span><span class="o">-&gt;</span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span>
<span class="w">    </span><span class="n">set_head</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">av</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">main_arena</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">NON_MAIN_ARENA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
<span class="w">    </span><span class="n">set_head</span><span class="p">(</span><span class="n">remainder</span><span class="p">,</span><span class="w"> </span><span class="n">remainder_size</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PREV_INUSE</span><span class="p">);</span>
<span class="w">    </span><span class="n">check_malloced_chunk</span><span class="p">(</span><span class="n">av</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">nb</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">chunk2mem</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<h4 id="capture-all-errors">Capture all errors<a class="headerlink" href="#capture-all-errors" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="cm">/* catch all failure paths */</span>
<span class="w">  </span><span class="n">__set_errno</span><span class="p">(</span><span class="n">ENOMEM</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 mahaloz
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "search.suggest", "search.highlight", "search.share"], "search": "../../../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://cdnjs.loli.net/ajax/libs/pangu/3.3.0/pangu.min.js"></script>
      
        <script src="../../../../../_static/js/extra.js"></script>
      
        <script src="https://cdnjs.loli.net/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>